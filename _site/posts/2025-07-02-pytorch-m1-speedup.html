<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Pytorch M1 Speedup</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" media="print" onload="this.media='all'">
<noscript>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
</noscript>



<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="manifest" href="/assets/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#f0f0f0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Jeffrey Taylor's App">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="msapplication-TileColor" content="#2d89ef">
  <meta name="msapplication-starturl" content="/">
  <meta name="application-name" content="Jeffrey Taylor's App">
  <meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">

    <meta name="keywords" content="">

  <meta name="description" content="~7x Speedup: PyTorch on Apple M1 Pro for MLOps Jeffrey Taylor Achieved ~7x speedup in PyTorch on Apple M1 Pro using MLflow. Learn MLOps optimizatio...">
  <meta name="robots" content="index, follow">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Pytorch M1 Speedup">

<meta name="twitter:description" content="~7x Speedup: PyTorch on Apple M1 Pro for MLOps Jeffrey Taylor Achieved ~7x speedup in PyTorch on Apple M1 Pro using MLflow. Learn MLOps optimization...">
<meta name="twitter:image" content="http://0.0.0.0:4000/assets/img/home/home-heading.jpg">
<meta property="og:site_name" content="Jeffrey Taylor">
<meta property="og:type" content="article">
<meta property="og:title" content="Pytorch M1 Speedup">
<meta property="og:description" content="~7x Speedup: PyTorch on Apple M1 Pro for MLOps Jeffrey Taylor Achieved ~7x speedup in PyTorch on Apple M1 Pro using MLflow. Learn MLOps optimizatio...">
<meta property="og:url" content="http://0.0.0.0:4000/posts/2025-07-02-pytorch-m1-speedup">
<meta property="og:image" content="http://0.0.0.0:4000/assets/img/home/home-heading.jpg">
  <meta property="article:author" content="Jeffrey Taylor">
  <meta property="article:section" content="">
  <script type="application/ld+json">{
  "@context": "https://schema.org"
  ,"@graph": [
    {
      "@type": "Person"
      ,"@id": "http://0.0.0.0:4000/#person"
      ,"name": "Jeffrey Taylor"
      ,"url": "http://0.0.0.0:4000/tabs/about.html"
      ,"image": "http://0.0.0.0:4000/assets/img/about/about.jpg"
      ,"description": "Jeffrey Taylor - MLOps Engineer specializing in production-ready machine learning infrastructure, Kubernetes orchestration, and automated ML workfl..."
  },{
    "@type": "WebSite"
    ,"@id": "http://0.0.0.0:4000/#website"
    ,"url": "http://0.0.0.0:4000/"
    ,"name": "Jeffrey Taylor"
    ,"description": "Jeffrey Taylor - MLOps Engineer specializing in production-ready machine learning infrastructure, Kubernetes orchestration, and automated ML workfl..."
    ,"publisher": {"@id": "http://0.0.0.0:4000/#person"}
    ,"inLanguage": "en-US"
    ,"sameAs": ["https://github.com/jtayl222","https://www.linkedin.com/in/jefftaylor22"]
    ,"copyrightHolder" : {"@id": "http://0.0.0.0:4000/#person"}
    ,"copyrightYear" : ""
  },{
    "@type": "WebPage"
    ,"@id": "http://0.0.0.0:4000/posts/2025-07-02-pytorch-m1-speedup#webpage"
    ,"url": "http://0.0.0.0:4000/posts/2025-07-02-pytorch-m1-speedup"
    ,"name": "Pytorch M1 Speedup"
    ,"isPartOf": {"@id": "http://0.0.0.0:4000/#website"}
    ,"breadcrumb": {"@id": "http://0.0.0.0:4000/posts/2025-07-02-pytorch-m1-speedup#breadcrumb"}
    ,"primaryImageOfPage": "http://0.0.0.0:4000/assets/img/home/home-heading.jpg"
    ,"description": "~7x Speedup: PyTorch on Apple M1 Pro for MLOps Jeffrey Taylor Achieved ~7x speedup in PyTorch on Apple M1 Pro using MLflow. Learn MLOps optimizatio..."
    ,"inLanguage": "en-US"
    ,"potentialAction": {
      "@type": "ReadAction"
      ,"target": "http://0.0.0.0:4000/posts/2025-07-02-pytorch-m1-speedup"
    }
  },{
      "@type": "BreadcrumbList",
      "@id": "http://0.0.0.0:4000/posts/2025-07-02-pytorch-m1-speedup#breadcrumb",
      "itemListElement": [
        {
          "@type": "ListItem"
          ,"position": 1
          ,"name": "Home"
          ,"item": "http://0.0.0.0:4000/"
        },
        {
          "@type": "ListItem"
          ,"position": 2
          ,"name": "Blog"
          ,"item": ""
        },
        {
          "@type": "ListItem"
          ,"position": 3
          ,"name": "Pytorch M1 Speedup"
        }
      ]
    },{
      "@type": "BlogPosting"
      ,"@id": "http://0.0.0.0:4000/posts/2025-07-02-pytorch-m1-speedup#content"
      ,"isPartOf": {"@id": "http://0.0.0.0:4000/posts/2025-07-02-pytorch-m1-speedup#webpage"}
      ,"mainEntityOfPage": {"@id": "http://0.0.0.0:4000/posts/2025-07-02-pytorch-m1-speedup#webpage"}
      ,"publisher": {"@id": "http://0.0.0.0:4000/#person"}
      ,"author": {"@id": "http://0.0.0.0:4000/#person"}
      ,"inLanguage": "en-US"
      ,"headline": "Pytorch M1 Speedup"
      ,"image": "http://0.0.0.0:4000/assets/img/home/home-heading.jpg"
      ,"thumbnailUrl": "http://0.0.0.0:4000/assets/img/home/home-heading.jpg"
      ,"articleSection": [""]
      ,"description": "~7x Speedup: PyTorch on Apple M1 Pro for MLOps Jeffrey Taylor Achieved ~7x speedup in PyTorch on Apple M1 Pro using MLflow. Learn MLOps optimizatio..."
      ,"copyrightHolder" : {"@id": "http://0.0.0.0:4000/#person"}
      ,"copyrightYear" : ""
      ,"wordCount": 747
      ,"articleBody": "~7x Speedup: PyTorch on Apple M1 Pro for MLOps Jeffrey Taylor Achieved ~7x speedup in PyTorch on Apple M1 Pro using MLflow. Learn MLOps optimization &amp; debugging for deep learning. Results vary by setup. Introduction: The Need for Speed in MLOps In the fast-paced world of machine learning, MLOps engineers are tasked with delivering faster iterations, quicker insights, and cost-effective solutions. Initially, I trained a deep learning model for image classification using PyTorch on an Intel Core i7-10710U, achieving an epoch time of 690 seconds. On an Apple M1 Pro, the baseline epoch time was ~563 seconds. While MLflow effectively tracked my experiments, I saw an opportunity for optimization. This article details how I optimized the training pipeline on the Apple M1 Pro, achieving a 6.8x speedup (epoch time 82.5 seconds), outperforming the Intel i7 by 8.4x, all while maintaining robust experiment tracking with MLflow. Your mileage may vary depending on hardware age, model architecture, dataset size, and system configurations like PyTorch or macOS versions. Key Learnings: Optimize PyTorch workloads for Apple Silicon using Metal Performance Shaders (MPS). Debug complex cross-platform issues in MLOps pipelines. Leverage MLflow for performance tracking and reproducibility. Apply hardware-aware performance engineering in MLOps. The Starting Point: Performance on Intel Core i7 and Apple M1 Pro Intel Core i7-10710U: Epoch Time: 690 seconds. Observations: The Python process consumed 550% CPU (5.5 cores out of 12), with overall CPU usage at ~45%. Interpretation: MKL optimized CPU computations, but the absence of a dedicated GPU limited parallel computations. Apple M1 Pro (Baseline, CPU-only): Epoch Time: 563 seconds. Interpretation: The M1’s ARM-based CPU was ~18% faster than the Intel i7, likely due to efficiency and unified memory, but still suboptimal without leveraging the GPU. Hypothesis Both CPUs were limited for deep learning’s parallel computations. I hypothesized that enabling the M1 Pro’s GPU via Metal Performance Shaders (MPS) would unlock significant performance gains, especially compared to the Intel system’s CPU-only setup. The Transition to Apple M1 Pro: A New Horizon The Apple M1 Pro is designed for machine learning workloads, with: ARM-based Architecture: Optimized for efficiency. Unified Memory Architecture: CPU, GPU, and Neural Engine share high-bandwidth RAM. Integrated GPU with Metal Performance Shaders (MPS): High-performance computing, accessible via PyTorch’s MPS backend. The Optimization Journey: Debugging and Discovering Speed To leverage the M1 Pro’s GPU, I updated the device selection logic: device = torch.device( \"mps\" if torch.backends.mps.is_available() else \"cuda:0\" if torch.cuda.is_available() else \"cpu\" ) model.to(device) Challenge 1: RuntimeError: Mismatched Tensor Types in NNPack ConvolutionOutput Problem: After enabling MPS, encountered: RuntimeError: Mismatched tensor types in NNPack convolutionOutput Cause: Tensors (inputs, labels) not explicitly moved to the mps device. Solution: Verified MPS availability with torch.backends.mps.is_available(). Ensured all tensors were moved: inputs, labels = inputs.to(device), labels.to(device) Disabled NNPack with os.environ[\"PYTORCH_ENABLE_NNPACK\"] = \"0\" as a fallback. Challenge 2: RuntimeError: Too Many Open Files with num_workers Problem: Increasing num_workers in the DataLoader caused: RuntimeError: Too many open files Cause: macOS’s default file descriptor limit (ulimit -n 256). Solution: Temporarily increased the limit: ulimit -n 4096 Set sharing strategy: import torch.multiprocessing as mp mp.set_sharing_strategy('file_system') Reduced num_workers and disabled pin_memory. Challenge 3: TypeError: Can’t Convert MPS Tensor to NumPy (MLflow Logging) Problem: Logging an input_example to MLflow raised: TypeError: can't convert mps:0 device type tensor to numpy Cause: NumPy requires CPU memory, but MPS tensors are on the GPU. Solution: Used .cpu().detach().numpy() to move tensors to CPU: single_input_example_np = single_input_example.cpu().detach().numpy() Fixed a trailing comma bug. The Breakthrough: ~7x Speedup on M1 Pro After resolving these issues, the M1 Pro achieved an average epoch time of 82.5 seconds, compared to: 563 seconds (baseline on M1 Pro, CPU-only): ~6.8x speedup. 690 seconds (Intel i7): ~8.4x speedup. Why So Fast? MPS Backend: Offloads computations to the M1’s GPU, optimized for parallel operations. Unified Memory: Eliminates CPU-GPU data transfer bottlenecks. Efficiency: Leverages specialized hardware for high performance. Note: Results may vary based on hardware, model complexity, dataset size, batch size, or software versions. MLOps Takeaways &amp; Conclusion This project demonstrates key MLOps skills: Performance Engineering: Achieved ~6.8x speedup on M1 Pro and ~8.4x over Intel i7. Hardware Awareness: Optimized for Apple Silicon’s MPS and unified memory. Troubleshooting: Resolved complex errors across PyTorch and MLflow. Cross-Platform Adaptation: Migrated and optimized a pipeline for a new architecture. MLflow Observability: Tracked experiments for reproducibility. Continuous Improvement: Iteratively refined the pipeline. MLOps engineers must understand compute environments to build scalable solutions. Explore the code on GitHub, review the MLflow setup, and follow the MLOps Engineering Portfolio for more insights. Written by Jeffrey Taylor"
    }
  ]
}</script>


    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<link href="/assets/css/main.css" rel="stylesheet"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v0.4.1/dist/bootstrap-toc.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/magnific-popup.css">
<link href="/assets/css/nav-media.css" rel="stylesheet">

  </head>

  <body >
    <script src="/assets/js/color-scheme-attr-init.js" data-mode="false"></script>
    <nav class="navbar navbar-default top-nav">
  <div class="navbar-header">
    <button type="button" aria-label="Side menu" class="navbar-toggle collapsed pull-left top-nav-menu-toggle" data-toggle="collapse" data-target="#id_top-nav-menu-toggle" aria-expanded="false">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand top-nav-brand" href="/" translate="no">Jeffrey Taylor</a>
    </div>
  <div class="color_scheme_switch_top_holder" data-toggle="tooltip" data-placement="bottom" title="Color scheme">
  <label class="color-scheme-switch hover-effect">
    <input type="checkbox" class="checkbox_color_switch" />
    <span></span>
  </label>
</div>

  
</nav>
<nav id="side-nav-container">
  <div class="side-nav">
    <div class="side-nav-brand">
      <img src="/assets/img/default/profile_pic.jpg" alt="">
      <div class="brand-holder">
        <a href="/" translate="no">Jeffrey Taylor</a>
        </div>
      <p>&nbsp;MLOps Engineer</p>
      <br>
        
    </div>
    <br>
    <a href="javascript:void(0);" class="side-nav-close" role="button" rel="nofollow">
        <i class="fa fa-angle-double-left fa-2x" aria-hidden="true"></i>
      </a>
    <hr>
    <br>
    <div class="side-nav-buttons">
      <ul class="nav nav-pills nav-stacked">
        <li ><a href="/" class=" hover-effect"><i class="fa-fw fa fa-home" aria-hidden="true"></i>Home</a></li><li ><a href="/tabs/projects.html" class=" hover-effect"><i class="fa-fw fa fa-cog" aria-hidden="true"></i>Projects</a></li><li ><a href="/tabs/platform-demo.html" class=" hover-effect"><i class="fa-fw " aria-hidden="true"></i>My Kubernetes Platform</a></li><li ><a href="/tabs/skills.html" class=" hover-effect"><i class="fa-fw fa fa-code" aria-hidden="true"></i>Skills</a></li><li ><a href="/tabs/publications.html" class=" hover-effect"><i class="fa-fw fa fa-file-text-o" aria-hidden="true"></i>Publications</a></li><li ><a href="/tabs/certifications.html" class=" hover-effect"><i class="fa-fw fa fa-certificate" aria-hidden="true"></i>Certifications</a></li><li ><a href="/tabs/resume/" class=" hover-effect"><i class="fa-fw fa fa-file-text" aria-hidden="true"></i>Resume</a></li><li ><a href="/tabs/about.html" class=" hover-effect"><i class="fa-fw fa fa-user-o" aria-hidden="true"></i>About</a></li></ul>
    </div>
    <br>
    <br><div class="contact-container">
  <hr>
  <h3>Contact</h3>
  <ul><li><a href="https://github.com/jtayl222" aria-label="github" class="hover-effect-big" target="_blank" rel="noopener noreferrer"><i class="fa fa-github" aria-hidden="true"></i></a></li><li><a href="https://www.linkedin.com/in/jefftaylor22" aria-label="linkedin" class="hover-effect-big" target="_blank" rel="noopener noreferrer"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li></ul>
</div>

    <hr id="toc-view-top">
    <div class="side-nav-footer" translate="no">
        <p>&copy;  Jeffrey Taylor.</p>
      </div>
  </div>
  <div class="side-nav-bottom-buttons-container">
    <hr>
    <ul>
      <li><div class="color_scheme_switch_side_holder" data-toggle="tooltip" data-placement="top" title="Color scheme">
  <label class="color-scheme-switch hover-effect">
    <input type="checkbox" class="checkbox_color_switch" />
    <span></span>
  </label>
</div>
</li><li><div class="cookie-icon hover-effect" onclick="CookieConsent.showSettings();" data-toggle="tooltip" data-placement="top" title="Cookie settings">
  <div class="cookie-wrapper">
    <i class="fa fa-circle bitten-cookie" aria-hidden="true"></i>
    <i class="fa fa-circle small-ellipse-icon" aria-hidden="true"></i>
    <i class="fa fa-spinner inner-icon" aria-hidden="true"></i>
    <i class="fa fa-circle-thin outer-icon" aria-hidden="true"></i>
  </div>
</div>
</li></ul>
  </div></nav>
<div id="toc-container" class="movable">
  <div class="panel panel-default">
    <div class="panel-heading" data-toggle="tooltip" data-placement="top" title="Drag to move">
      Contents
      <span class="pull-right">
        <a href="javascript:void(0);" aria-label="Close" role="button" rel="nofollow" class="close-button" onclick="document.getElementById('toc-container').style.display = 'none';">
          <i class="fa fa-times" data-toggle="tooltip" data-placement="bottom" title="Close"></i>
        </a>
      </span>
    </div>
    <div class="panel-body">
      <nav id="table-of-contents"></nav>
    </div>
  </div>
</div>
<div id="main-wrapper">
      <div class="main-container"><div class="multipurpose-container post-container">
  <div class="post-title"><h1>Pytorch M1 Speedup</h1></div><div class="meta">
  <small>
    &nbsp;<i class="fa fa-calendar"></i>&nbsp;&nbsp;Jul 2, 2025
  </small>
  <small>
    &nbsp;&nbsp;&nbsp;<span><i class="fa fa-clock-o"></i>&nbsp;4 min read</span>
  </small>
  </div>
<hr/>
  <div class="markdown-style">
    <h1 id="7x-speedup-pytorch-on-apple-m1-pro-for-mlops">~7x Speedup: PyTorch on Apple M1 Pro for MLOps</h1>

<p><a href="https://jeftaylo.medium.com/?source=post_page---byline--fa1c10482c65---------------------------------------">Jeffrey Taylor</a></p>

<p><em>Achieved ~7x speedup in PyTorch on Apple M1 Pro using MLflow. Learn MLOps optimization &amp; debugging for deep learning. Results vary by setup.</em></p>

<hr />

<h2 id="introduction-the-need-for-speed-in-mlops">Introduction: The Need for Speed in MLOps</h2>

<p>In the fast-paced world of machine learning, MLOps engineers are tasked with delivering faster iterations, quicker insights, and cost-effective solutions.</p>

<p>Initially, I trained a deep learning model for image classification using PyTorch on an Intel Core i7-10710U, achieving an epoch time of 690 seconds. On an Apple M1 Pro, the baseline epoch time was ~563 seconds. While MLflow effectively tracked my experiments, I saw an opportunity for optimization.</p>

<p>This article details how I optimized the training pipeline on the Apple M1 Pro, achieving a <strong>6.8x speedup</strong> (epoch time 82.5 seconds), outperforming the Intel i7 by <strong>8.4x</strong>, all while maintaining robust experiment tracking with MLflow.</p>

<p><em>Your mileage may vary depending on hardware age, model architecture, dataset size, and system configurations like PyTorch or macOS versions.</em></p>

<p><strong>Key Learnings:</strong></p>
<ul>
  <li>Optimize PyTorch workloads for Apple Silicon using Metal Performance Shaders (MPS).</li>
  <li>Debug complex cross-platform issues in MLOps pipelines.</li>
  <li>Leverage MLflow for performance tracking and reproducibility.</li>
  <li>Apply hardware-aware performance engineering in MLOps.</li>
</ul>

<hr />

<h2 id="the-starting-point-performance-on-intel-core-i7-and-apple-m1-pro">The Starting Point: Performance on Intel Core i7 and Apple M1 Pro</h2>

<p><strong>Intel Core i7-10710U:</strong></p>
<ul>
  <li>Epoch Time: 690 seconds.</li>
  <li>Observations: The Python process consumed 550% CPU (5.5 cores out of 12), with overall CPU usage at ~45%.</li>
  <li>Interpretation: MKL optimized CPU computations, but the absence of a dedicated GPU limited parallel computations.</li>
</ul>

<p><strong>Apple M1 Pro (Baseline, CPU-only):</strong></p>
<ul>
  <li>Epoch Time: 563 seconds.</li>
  <li>Interpretation: The M1’s ARM-based CPU was ~18% faster than the Intel i7, likely due to efficiency and unified memory, but still suboptimal without leveraging the GPU.</li>
</ul>

<hr />

<h2 id="hypothesis">Hypothesis</h2>

<p>Both CPUs were limited for deep learning’s parallel computations. I hypothesized that enabling the M1 Pro’s GPU via Metal Performance Shaders (MPS) would unlock significant performance gains, especially compared to the Intel system’s CPU-only setup.</p>

<hr />

<h2 id="the-transition-to-apple-m1-pro-a-new-horizon">The Transition to Apple M1 Pro: A New Horizon</h2>

<p>The Apple M1 Pro is designed for machine learning workloads, with:</p>
<ul>
  <li><strong>ARM-based Architecture:</strong> Optimized for efficiency.</li>
  <li><strong>Unified Memory Architecture:</strong> CPU, GPU, and Neural Engine share high-bandwidth RAM.</li>
  <li><strong>Integrated GPU with Metal Performance Shaders (MPS):</strong> High-performance computing, accessible via PyTorch’s MPS backend.</li>
</ul>

<hr />

<h2 id="the-optimization-journey-debugging-and-discovering-speed">The Optimization Journey: Debugging and Discovering Speed</h2>

<p>To leverage the M1 Pro’s GPU, I updated the device selection logic:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">device</span><span class="p">(</span>
    <span class="sh">"</span><span class="s">mps</span><span class="sh">"</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">backends</span><span class="p">.</span><span class="n">mps</span><span class="p">.</span><span class="nf">is_available</span><span class="p">()</span> 
    <span class="k">else</span> <span class="sh">"</span><span class="s">cuda:0</span><span class="sh">"</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nf">is_available</span><span class="p">()</span> 
    <span class="k">else</span> <span class="sh">"</span><span class="s">cpu</span><span class="sh">"</span>
<span class="p">)</span>
<span class="n">model</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="challenge-1-runtimeerror-mismatched-tensor-types-in-nnpack-convolutionoutput">Challenge 1: RuntimeError: Mismatched Tensor Types in NNPack ConvolutionOutput</h3>

<p><strong>Problem:</strong><br />
After enabling MPS, encountered:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RuntimeError: Mismatched tensor types in NNPack convolutionOutput
</code></pre></div></div>
<p><strong>Cause:</strong><br />
Tensors (inputs, labels) not explicitly moved to the mps device.</p>

<p><strong>Solution:</strong></p>
<ul>
  <li>Verified MPS availability with <code class="language-plaintext highlighter-rouge">torch.backends.mps.is_available()</code>.</li>
  <li>Ensured all tensors were moved:
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">labels</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>Disabled NNPack with
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">PYTORCH_ENABLE_NNPACK</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span>
</code></pre></div>    </div>
    <p>as a fallback.</p>
  </li>
</ul>

<h3 id="challenge-2-runtimeerror-too-many-open-files-with-num_workers">Challenge 2: RuntimeError: Too Many Open Files with num_workers</h3>

<p><strong>Problem:</strong><br />
Increasing <code class="language-plaintext highlighter-rouge">num_workers</code> in the DataLoader caused:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RuntimeError: Too many open files
</code></pre></div></div>
<p><strong>Cause:</strong><br />
macOS’s default file descriptor limit (<code class="language-plaintext highlighter-rouge">ulimit -n 256</code>).</p>

<p><strong>Solution:</strong></p>
<ul>
  <li>Temporarily increased the limit:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ulimit</span> <span class="nt">-n</span> 4096
</code></pre></div>    </div>
  </li>
  <li>Set sharing strategy:
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">torch.multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>
<span class="n">mp</span><span class="p">.</span><span class="nf">set_sharing_strategy</span><span class="p">(</span><span class="sh">'</span><span class="s">file_system</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>Reduced <code class="language-plaintext highlighter-rouge">num_workers</code> and disabled <code class="language-plaintext highlighter-rouge">pin_memory</code>.</li>
</ul>

<h3 id="challenge-3-typeerror-cant-convert-mps-tensor-to-numpy-mlflow-logging">Challenge 3: TypeError: Can’t Convert MPS Tensor to NumPy (MLflow Logging)</h3>

<p><strong>Problem:</strong><br />
Logging an input_example to MLflow raised:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TypeError: can't convert mps:0 device type tensor to numpy
</code></pre></div></div>
<p><strong>Cause:</strong><br />
NumPy requires CPU memory, but MPS tensors are on the GPU.</p>

<p><strong>Solution:</strong></p>
<ul>
  <li>Used <code class="language-plaintext highlighter-rouge">.cpu().detach().numpy()</code> to move tensors to CPU:
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">single_input_example_np</span> <span class="o">=</span> <span class="n">single_input_example</span><span class="p">.</span><span class="nf">cpu</span><span class="p">().</span><span class="nf">detach</span><span class="p">().</span><span class="nf">numpy</span><span class="p">()</span>
</code></pre></div>    </div>
  </li>
  <li>Fixed a trailing comma bug.</li>
</ul>

<hr />

<h2 id="the-breakthrough-7x-speedup-on-m1-pro">The Breakthrough: ~7x Speedup on M1 Pro</h2>

<p>After resolving these issues, the M1 Pro achieved an average epoch time of <strong>82.5 seconds</strong>, compared to:</p>
<ul>
  <li>563 seconds (baseline on M1 Pro, CPU-only): ~6.8x speedup.</li>
  <li>690 seconds (Intel i7): ~8.4x speedup.</li>
</ul>

<hr />

<h2 id="why-so-fast">Why So Fast?</h2>

<ul>
  <li><strong>MPS Backend:</strong> Offloads computations to the M1’s GPU, optimized for parallel operations.</li>
  <li><strong>Unified Memory:</strong> Eliminates CPU-GPU data transfer bottlenecks.</li>
  <li><strong>Efficiency:</strong> Leverages specialized hardware for high performance.</li>
</ul>

<p><em>Note: Results may vary based on hardware, model complexity, dataset size, batch size, or software versions.</em></p>

<hr />

<h2 id="mlops-takeaways--conclusion">MLOps Takeaways &amp; Conclusion</h2>

<p>This project demonstrates key MLOps skills:</p>
<ul>
  <li><strong>Performance Engineering:</strong> Achieved ~6.8x speedup on M1 Pro and ~8.4x over Intel i7.</li>
  <li><strong>Hardware Awareness:</strong> Optimized for Apple Silicon’s MPS and unified memory.</li>
  <li><strong>Troubleshooting:</strong> Resolved complex errors across PyTorch and MLflow.</li>
  <li><strong>Cross-Platform Adaptation:</strong> Migrated and optimized a pipeline for a new architecture.</li>
  <li><strong>MLflow Observability:</strong> Tracked experiments for reproducibility.</li>
  <li><strong>Continuous Improvement:</strong> Iteratively refined the pipeline.</li>
</ul>

<p>MLOps engineers must understand compute environments to build scalable solutions.<br />
<em>Explore the code on GitHub, review the MLflow setup, and follow the <a href="https://jeftaylo.medium.com/mlops-engineering-portfolio-3946a461efda">MLOps Engineering Portfolio</a> for more insights.</em></p>

<hr />

<p><a href="https://jeftaylo.medium.com/?source=post_page---post_author_info--fa1c10482c65---------------------------------------">Written by Jeffrey Taylor</a></p>
<hr>
<div class="share-holder">
  <span class="share-label">Share on: </span>
  <ul class="share-buttons">
    
      <li>
        <a href="https://twitter.com/intent/tweet?url=http%3A%2F%2F0.0.0.0%3A4000%2Fposts%2F2025-07-02-pytorch-m1-speedup&amp;text=Pytorch%20M1%20Speedup%20-%20Jeffrey%20Taylor" aria-label="Twitter" role="button" target="_blank" rel="noopener noreferrer" data-toggle="tooltip" data-placement="top" title="Twitter" class="hover-effect-big">
          <i class="fa fa-twitter-square fa-fw" aria-hidden="true"></i>
        </a>
      </li>
    
      <li>
        <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2F0.0.0.0%3A4000%2Fposts%2F2025-07-02-pytorch-m1-speedup" aria-label="Facebook" role="button" target="_blank" rel="noopener noreferrer" data-toggle="tooltip" data-placement="top" title="Facebook" class="hover-effect-big">
          <i class="fa fa-facebook-square fa-fw" aria-hidden="true"></i>
        </a>
      </li>
    
      <li>
        <a href="https://t.me/share/url?url=http%3A%2F%2F0.0.0.0%3A4000%2Fposts%2F2025-07-02-pytorch-m1-speedup&amp;text=Pytorch%20M1%20Speedup%20-%20Jeffrey%20Taylor" aria-label="Telegram" role="button" target="_blank" rel="noopener noreferrer" data-toggle="tooltip" data-placement="top" title="Telegram" class="hover-effect-big">
          <i class="fa fa-telegram fa-fw" aria-hidden="true"></i>
        </a>
      </li>
    
      <li>
        <a href="https://www.linkedin.com/sharing/share-offsite/?url=http%3A%2F%2F0.0.0.0%3A4000%2Fposts%2F2025-07-02-pytorch-m1-speedup" aria-label="LinkedIn" role="button" target="_blank" rel="noopener noreferrer" data-toggle="tooltip" data-placement="top" title="LinkedIn" class="hover-effect-big">
          <i class="fa fa-linkedin-square fa-fw" aria-hidden="true"></i>
        </a>
      </li>
    
      <li>
        <a href="mailto:?subject=Pytorch%20M1%20Speedup%20-%20Jeffrey%20Taylor&amp;body=Pytorch%20M1%20Speedup%20-%20Jeffrey%20Taylor%20http%3A%2F%2F0.0.0.0%3A4000%2Fposts%2F2025-07-02-pytorch-m1-speedup" aria-label="Email" role="button" target="_blank" rel="noopener noreferrer" data-toggle="tooltip" data-placement="top" title="Email" class="hover-effect-big">
          <i class="fa fa-envelope fa-fw" aria-hidden="true"></i>
        </a>
      </li>
    
      <li>
        <a href="javascript:void(0);" aria-label="Copy link" role="button" onclick="copyToClipboard('http://0.0.0.0:4000/posts/2025-07-02-pytorch-m1-speedup', 'Link copied!')" id="copytoclipboard" data-toggle="tooltip" data-placement="top" title="Copy link" class="hover-effect-big">
          <i class="fa fa-link fa-fw" aria-hidden="true"></i>
        </a>
      </li>
    
  </ul>
</div>
</div>
</div>

    <div class="pagination_wrapper">
  <nav aria-label="Page navigation">
    <ul class="pagination" style="opacity:0">
    <li><a href="javascript:void(0);" role="button">1</a></li></ul>
  </nav>
</div>

</div><div class="footer-wrapper">
  <div class="footer-container">
    <footer translate="no">
      <div class="footer-text footer-text-centered long-copyright">
          <p>&copy;  Jeffrey Taylor. </p><a href="https://creativecommons.org/licenses/by-sa/4.0/deed.en" target="_blank" rel="noopener noreferrer" data-toggle="tooltip" data-placement="top" data-tooltip-no-hide title="Except where otherwise noted, content on this web site is licensed under a Creative Commons Attribution-ShareAlike 4.0 International License.">
              <img src="/assets/img/default/cc/cc.svg" alt="cc" width="12" height="12">&nbsp;<img src="/assets/img/default/cc/by.svg" alt="by" width="12" height="12">&nbsp;<img src="/assets/img/default/cc/sa.svg" alt="sa" width="12" height="12">&nbsp;<p>Some rights reserved.</p>
            </a></div>
      <p class="footer-powered"><span>Pwrd by </span><a href="https://github.com/MrGreensWorkshop/MrGreen-JekyllTheme" target="_blank" rel="noopener noreferrer">Mr. Green</a></p>
    </footer>
  </div>
</div>
<div class="scroll-to-top-container">
        <a id="scroll-to-top" href="#main-wrapper" role="button" aria-label="Back to top" class="hover-effect"><i class="fa fa-angle-up"></i></a>
      </div></div>

    <div class="searchbox-container">
  <form id="searchbox-form" autocomplete="off">
    <input type="search" id="search-box" placeholder="Search"
    onkeyup="if(this.value!==''){document.getElementById('search-results').style.display = 'block';}"
    onfocusout="this.value='';"
    onblur="setTimeout(function(){ document.getElementById('search-results').style.display = 'none'; }, 100);">
    <ul id="search-results" ></ul>
  </form>
</div>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v0.4.1/dist/bootstrap-toc.min.js"></script>

<script src="/assets/js/main.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js"></script>
    <script>
      $('.imgViewer[data-no-image-viewer]').css("cursor", "unset");
      $(function () {
        $('.imgViewer:not([data-no-image-viewer])').magnificPopup({
          type: 'image'
          ,image: {
            titleSrc: 'alt'
            /* Error message */
            ,tError: "The image could not be loaded.<br><br>%url%"
            /* Set to null to disable zoom out cursor. */
            /*,cursor: null */
          }
          ,closeOnContentClick: true
          ,showCloseBtn: false
          ,zoom: {
            /* By default it's false, so don't forget to enable it */
            enabled: true
            /* duration of the effect, in milliseconds */
            ,duration: 300
            /* CSS transition easing function */
            ,easing: 'ease-in-out'
          }
        });
      });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js"></script>
    <script>
      /* lazy loads elements with default selector as '.lozad' */
      const observer = lozad();
      observer.observe();
    </script>

<script>
      PagerPageNumbers.setProperties({
        paginatorListContainerName: ".pagination_wrapper .pagination"
        ,pageList: ["/posts/2025-07-02-welcome-to-jekyll", "/posts/2025-07-02-pytorch-m1-speedup", "/posts/2025-07-02-Automating-MLOps-Scalable-ML-Pipelines", "/posts/2025-07-02-13-medium-articles"]
        ,firstButtonName: "First"
        ,lastButtonName: "Last"
        ,prevButtonName: "«"
        ,nextButtonName: "»"
      });
    </script>



<script src="/assets/js/simple-jekyll-search-1.9.2.min.js"></script><script>
  function loadSearch(jsonData, searchParam) {
    if (!jsonData) jsonData = '';
    var searchInput = document.getElementById('search-box');

    const simpleJekyllSearch = SimpleJekyllSearch({
      searchInput: searchInput
      ,resultsContainer: document.getElementById('search-results')
      ,json: jsonData
      ,searchResultTemplate: '<li> <a href="{url}"> <div> <div class="title">{title}</div> <div class="date">{date}</div> <div style="clear: both;"></div> </div> </a></li>'
      ,noResultsText: '<li>No results were found.</li>'
      ,limit: 10
      ,fuzzy: false
      ,formSubmit: document.getElementById('searchbox-form')
    });

    if (searchParam) {
      searchInput.value = searchParam;
      searchInput.focus();
      searchInput.disabled=false;
      setTimeout(function(){
        simpleJekyllSearch.search(searchParam);
      }, 400);
    }
  }

  </script>

<script>
    function isEmpty(value) {
      if (value === "" || value === null || typeof value === "undefined") return true;
      return false;
    }

    function getQueryParam (param, mach = true) {
      var queryString = window.location.search.substring(1);
      if (isEmpty(queryString)) return null;
      var queries = queryString.split("&");
      for (var i in queries) {
        var pair = decodeURIComponent(queries[i]).split("=");
        if (mach == true){
          if (pair[0] == param) {
            if (isEmpty(pair[1]) === false) return pair[1];
          }
        }else{
          return pair;
        }
        break;
      }
      return null;
    }

    const searchParam = getQueryParam('search');

    (async () => {
      let resp = await fetch('');
      if (!resp.ok) return;
      let jsonData = await resp.json();
      loadSearch(jsonData, searchParam);
    })();
  </script>



<script>
  CookieConsent.consentSettingHtml = "<div class=\"consent-settings\"> <h5>Cookie settings</h5> <br> <p class=\"info-text\">This website uses cookies to optimize site functionality. It will be activated with your approval. Please click each item below for cookie policy. </p> <table> <tr> <td onclick=\"$('.info[data-consent-info=necessary]').slideToggle();$(this).children('i').toggleClass('fa-plus-square-o').toggleClass('fa-minus-square-o')\"> <i class=\"fa-fw fa fa-plus-square-o\" aria-hidden=\"true\"></i> <p>Strictly necessary cookies</p> </td> <td> <span class=\"active_text\">Always active</span></td> </tr> </table> <div class=\"info\" data-consent-info=\"necessary\"> <p>These cookies are essential for the website function and cannot be disable. They are usually set when site function like color scheme etc. is changed. These cookies do not store any personally identifiable information. Enables storage related to security such as authentication functionality, fraud prevention, and other user protection. </p> </div> <table> <tr> <td onclick=\"$('.info[data-consent-info=analytics]').slideToggle();$(this).children('i').toggleClass('fa-plus-square-o').toggleClass('fa-minus-square-o')\"> <i class=\"fa-fw fa fa-plus-square-o\" aria-hidden=\"true\"></i> <p>Performance cookies</p> </td> <td> <label class=\"slide-switch\"> <input type=\"checkbox\" class=\"checkbox_switch\" checked=\"checked\" data-consent=\"analytics\"> <span class=\"slider\"></span> </label></td> </tr> </table> <div class=\"info\" data-consent-info=\"analytics\"> <p>Enables storage (such as cookies) related to analytics e.g. visit duration. </p> </div> <table> <tr> <td onclick=\"$('.info[data-consent-info=preferences]').slideToggle();$(this).children('i').toggleClass('fa-plus-square-o').toggleClass('fa-minus-square-o')\"> <i class=\"fa-fw fa fa-plus-square-o\" aria-hidden=\"true\"></i> <p>Functionality cookies</p> </td> <td> <label class=\"slide-switch\"> <input type=\"checkbox\" class=\"checkbox_switch\" data-consent=\"preferences\"> <span class=\"slider\"></span> </label></td> </tr> </table> <div class=\"info\" data-consent-info=\"preferences\"> <p>Enables storage that supports the functionality of the website or app e.g. language settings. Enables storage related to personalization e.g. video recommendations. </p> </div> <table> <tr> <td onclick=\"$('.info[data-consent-info=advertising]').slideToggle();$(this).children('i').toggleClass('fa-plus-square-o').toggleClass('fa-minus-square-o')\"> <i class=\"fa-fw fa fa-plus-square-o\" aria-hidden=\"true\"></i> <p>Targeting and advertising cookies</p> </td> <td> <label class=\"slide-switch\"> <input type=\"checkbox\" class=\"checkbox_switch\" data-consent=\"advertising\"> <span class=\"slider\"></span> </label></td> </tr> </table> <div class=\"info\" data-consent-info=\"advertising\"> <p>Enables storage (such as cookies) related to advertising. </p> </div> <br> <div class=\"button-holder\"> <a href=\"javascript:void(0);\" class=\"btn-base btn-left\" onclick=\"CookieConsent.consentSettingDone('deny');\" role=\"button\" rel=\"nofollow\">Deny</a> <a href=\"javascript:void(0);\" class=\"btn-base btn-priority\" onclick=\"CookieConsent.consentSettingDone('accept');\" role=\"button\" rel=\"nofollow\">Allow all</a> <a href=\"javascript:void(0);\" class=\"btn-base \" onclick=\"CookieConsent.consentSettingDone('save');\" role=\"button\" rel=\"nofollow\">Allow selection</a> </div> </div>";
  CookieConsent.consentSettingSlideType = 'slideBoxTopToDown';
  CookieConsent.consentBarHtml = "<div class=\"consent-bar\"> <a class=\"close-button\" href=\"javascript:void(0);\" onclick=\"CookieConsent.hideConsentBar();\" aria-label=\"Close\" role=\"button\" rel=\"nofollow\"><i class=\"fa-fw fa fa-times\"></i></a> <p>This website uses cookies to optimize site functionality. It will be activated with your approval. </p> <a href=\"javascript:void(0);\" class=\"btn-base \" onclick=\"CookieConsent.consentBarDone('deny');\" role=\"button\" rel=\"nofollow\">Deny</a> <a href=\"javascript:void(0);\" class=\"btn-base \" onclick=\"CookieConsent.consentBarDone('settings');\" role=\"button\" rel=\"nofollow\">Customize</a> <a href=\"javascript:void(0);\" class=\"btn-base btn-priority\" onclick=\"CookieConsent.consentBarDone('accept');\" role=\"button\" rel=\"nofollow\">Allow all</a> </div>";
  CookieConsent.consent_items = JSON.parse('{"necessary":{"group":["security_storage"],"value":"granted","wait_for_update":500,"cookie_domain":"","no_check_box":true},"analytics":{"group":["analytics_storage"],"value":"denied"},"preferences":{"group":["functionality_storage","personalization_storage"],"value":"denied"},"advertising":{"group":["ad_storage"],"value":"denied"}}');
  CookieConsent.hideConsentBarWithSaveButton = true;

  const consent_settings = CookieConsent.getConsentSettings();
  const default_configs = JSON.parse('{"anonymize_ip":true,"ads_data_redaction":true,"cookie_flags":"SameSite=None;Secure"}');
</script>
<script>
  LangOfferMsgBox.currentPageLng = "en";
  LangOfferMsgBox.supportedLngList = [["en","En","/","View this page in English.","To home","Language"],["ja","Jp","/ja","このページを日本語で表示する。","日本語ホームへ","言語"],["pt","Pt","/pt","Veja esta página em português.","Página principal","Idioma"],["fr","Fr","/fr","Voir cette page en français.","Aller à l'accueil français","Langue"],["zh","Cn","/zh","显示简体中文页面","简体中文页面","语言"],["ko","Ko","/ko","이 페이지를 한국어로 보세요.","한국어 홈페이지로","언어"],["tr","Tr","/tr","Bu sayfayı Türkçe de görüntüleyin.","Türkçe Ana sayfaya","Dil"],["es","Es","/es","Ver esta página en español.","Ir a inicio","Idioma"]];
  LangOfferMsgBox.existLng = [];
  LangOfferMsgBox.disableExtTranslationOffer = true;
  LangOfferMsgBox.slideType = 'slideBoxTopToDown';
</script>
<script>
  SlidingMsgBox.html = "<div class=\"slideBox\"> <a class=\"close-button\" href=\"javascript:void(0);\" aria-label=\"Close\" role=\"button\" rel=\"nofollow\"><i class=\"fa-fw fa fa-times\"></i></a> </div>";
</script>
</body>
</html>

