<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Jeffrey Taylor - The MLflow Model Registry Story: A Journ...</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" media="print" onload="this.media='all'">
<noscript>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
</noscript>



<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="manifest" href="/assets/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#f0f0f0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Jeffrey Taylor's App">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="msapplication-TileColor" content="#2d89ef">
  <meta name="msapplication-starturl" content="/">
  <meta name="application-name" content="Jeffrey Taylor's App">
  <meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">


  <meta name="description" content="The MLflow Model Registry Story: A Journey Through Real-World MLOps üîç A Deep Dive into Production ML Challenges From feature engineering complexiti...">
  <meta name="robots" content="index, follow">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="The MLflow Model Registry Story: A Journey Through Real-World MLOps">

<meta name="twitter:description" content="The MLflow Model Registry Story: A Journey Through Real-World MLOps üîç A Deep Dive into Production ML Challenges From feature engineering complexities to questioning the business value of ML models ...">
<meta name="twitter:image" content="http://0.0.0.0:4000/assets/img/home/home-heading.jpg">
<meta property="og:site_name" content="Jeffrey Taylor">
<meta property="og:type" content="website">
<meta property="og:title" content="The MLflow Model Registry Story: A Journey Thro...">
<meta property="og:description" content="The MLflow Model Registry Story: A Journey Through Real-World MLOps üîç A Deep Dive into Production ML Challenges From feature engineering complexiti...">
<meta property="og:url" content="http://0.0.0.0:4000/mlflow-model-registry-story.html">
<meta property="og:image" content="http://0.0.0.0:4000/assets/img/home/home-heading.jpg">
  <script type="application/ld+json">{
  "@context": "https://schema.org"
  ,"@graph": [
    {
      "@type": "Person"
      ,"@id": "http://0.0.0.0:4000/#person"
      ,"name": "Jeffrey Taylor"
      ,"url": "http://0.0.0.0:4000/tabs/about.html"
      ,"image": "http://0.0.0.0:4000/assets/img/about/about.jpg"
      ,"description": "Jeffrey Taylor - MLOps Engineer specializing in production-ready machine learning infrastructure, Kubernetes orchestration, and automated ML workfl..."
  },{
    "@type": "WebSite"
    ,"@id": "http://0.0.0.0:4000/#website"
    ,"url": "http://0.0.0.0:4000/"
    ,"name": "Jeffrey Taylor"
    ,"description": "Jeffrey Taylor - MLOps Engineer specializing in production-ready machine learning infrastructure, Kubernetes orchestration, and automated ML workfl..."
    ,"publisher": {"@id": "http://0.0.0.0:4000/#person"}
    ,"inLanguage": "en-US"
    ,"sameAs": ["https://github.com/jtayl222","https://www.linkedin.com/in/jefftaylor22"]
    ,"copyrightHolder" : {"@id": "http://0.0.0.0:4000/#person"}
    ,"copyrightYear" : ""
  },{
    "@type": "WebPage"
    ,"@id": "http://0.0.0.0:4000/mlflow-model-registry-story.html#webpage"
    ,"url": "http://0.0.0.0:4000/mlflow-model-registry-story.html"
    ,"name": "The MLflow Model Registry Story: A Journey Through Real-World MLOps"
    ,"isPartOf": {"@id": "http://0.0.0.0:4000/#website"}
    ,"breadcrumb": {"@id": "http://0.0.0.0:4000/mlflow-model-registry-story.html#breadcrumb"}
    ,"primaryImageOfPage": "http://0.0.0.0:4000/assets/img/home/home-heading.jpg"
    ,"description": "The MLflow Model Registry Story: A Journey Through Real-World MLOps üîç A Deep Dive into Production ML Challenges From feature engineering complexiti..."
    ,"inLanguage": "en-US"
    ,"potentialAction": {
      "@type": "ReadAction"
      ,"target": "http://0.0.0.0:4000/mlflow-model-registry-story.html"
    }
  },{
      "@type": "BreadcrumbList",
      "@id": "http://0.0.0.0:4000/mlflow-model-registry-story.html#breadcrumb",
      "itemListElement": [
        {
          "@type": "ListItem"
          ,"position": 1
          ,"name": "Home"
          ,"item": "http://0.0.0.0:4000/"
        },
        {
          "@type": "ListItem"
          ,"position": 2
          ,"name": "The MLflow Model Registry Story: A Journey Through Real-World MLOps"
        }
      ]
    }
  ]
}</script>


    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<link href="/assets/css/main.css" rel="stylesheet"><link href="/assets/css/nav-media.css" rel="stylesheet">

  </head>

  <body >
    <script src="/assets/js/color-scheme-attr-init.js" data-mode="false"></script>
    <nav class="navbar navbar-default top-nav">
  <div class="navbar-header">
    <button type="button" aria-label="Side menu" class="navbar-toggle collapsed pull-left top-nav-menu-toggle" data-toggle="collapse" data-target="#id_top-nav-menu-toggle" aria-expanded="false">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand top-nav-brand" href="/" translate="no">Jeffrey Taylor</a>
    </div>
  <div class="color_scheme_switch_top_holder" data-toggle="tooltip" data-placement="bottom" title="Color scheme">
  <label class="color-scheme-switch hover-effect">
    <input type="checkbox" class="checkbox_color_switch" />
    <span></span>
  </label>
</div>

  
</nav>
<nav id="side-nav-container">
  <div class="side-nav">
    <div class="side-nav-brand">
      <img src="/assets/img/default/profile_pic.jpg" alt="">
      <div class="brand-holder">
        <a href="/" translate="no">Jeffrey Taylor</a>
        </div>
      <p>&nbsp;MLOps Engineer</p>
      <br>
        
    </div>
    <br>
    <a href="javascript:void(0);" class="side-nav-close" role="button" rel="nofollow">
        <i class="fa fa-angle-double-left fa-2x" aria-hidden="true"></i>
      </a>
    <hr>
    <br>
    <div class="side-nav-buttons">
      <ul class="nav nav-pills nav-stacked">
        <li ><a href="/" class=" hover-effect"><i class="fa-fw fa fa-home" aria-hidden="true"></i>Home</a></li><li ><a href="/tabs/projects.html" class=" hover-effect"><i class="fa-fw fa fa-cog" aria-hidden="true"></i>Projects</a></li><li ><a href="/tabs/platform-demo.html" class=" hover-effect"><i class="fa-fw " aria-hidden="true"></i>My Kubernetes Platform</a></li><li ><a href="/tabs/skills.html" class=" hover-effect"><i class="fa-fw fa fa-code" aria-hidden="true"></i>Skills</a></li><li ><a href="/tabs/publications.html" class=" hover-effect"><i class="fa-fw fa fa-file-text-o" aria-hidden="true"></i>Publications</a></li><li ><a href="/tabs/certifications.html" class=" hover-effect"><i class="fa-fw fa fa-certificate" aria-hidden="true"></i>Certifications</a></li><li ><a href="/tabs/resume/" class=" hover-effect"><i class="fa-fw fa fa-file-text" aria-hidden="true"></i>Resume</a></li><li ><a href="/tabs/about.html" class=" hover-effect"><i class="fa-fw fa fa-user-o" aria-hidden="true"></i>About</a></li></ul>
    </div>
    <br>
    <br><div class="contact-container">
  <hr>
  <h3>Contact</h3>
  <ul><li><a href="https://github.com/jtayl222" aria-label="github" class="hover-effect-big" target="_blank" rel="noopener noreferrer"><i class="fa fa-github" aria-hidden="true"></i></a></li><li><a href="https://www.linkedin.com/in/jefftaylor22" aria-label="linkedin" class="hover-effect-big" target="_blank" rel="noopener noreferrer"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li></ul>
</div>

    <hr id="toc-view-top">
    <div class="side-nav-footer" translate="no">
        <p>&copy;  Jeffrey Taylor.</p>
      </div>
  </div>
  <div class="side-nav-bottom-buttons-container">
    <hr>
    <ul>
      <li><div class="color_scheme_switch_side_holder" data-toggle="tooltip" data-placement="top" title="Color scheme">
  <label class="color-scheme-switch hover-effect">
    <input type="checkbox" class="checkbox_color_switch" />
    <span></span>
  </label>
</div>
</li><li><div class="cookie-icon hover-effect" onclick="CookieConsent.showSettings();" data-toggle="tooltip" data-placement="top" title="Cookie settings">
  <div class="cookie-wrapper">
    <i class="fa fa-circle bitten-cookie" aria-hidden="true"></i>
    <i class="fa fa-circle small-ellipse-icon" aria-hidden="true"></i>
    <i class="fa fa-spinner inner-icon" aria-hidden="true"></i>
    <i class="fa fa-circle-thin outer-icon" aria-hidden="true"></i>
  </div>
</div>
</li></ul>
  </div></nav>
<div id="main-wrapper">
      <div class="main-container"><h1 id="the-mlflow-model-registry-story-a-journey-through-real-world-mlops">The MLflow Model Registry Story: A Journey Through Real-World MLOps</h1>

<p><strong>üîç A Deep Dive into Production ML Challenges</strong></p>

<p><em>From feature engineering complexities to questioning the business value of ML models - an honest exploration of MLOps realities</em></p>

<hr />

<h2 id="introduction">Introduction</h2>

<p>This story follows Sarah, an experienced ML engineer, as she navigates the implementation of MLflow Model Registry in a financial technology environment. What begins as a straightforward technical implementation evolves into a profound exploration of the challenges, complexities, and sometimes uncomfortable truths about machine learning in production systems.</p>

<p>Through Sarah‚Äôs journey, we‚Äôll explore:</p>
<ul>
  <li>Real-world MLOps infrastructure challenges</li>
  <li>Feature engineering complexities in financial data</li>
  <li>A/B testing strategies for ML models</li>
  <li>The critical question: ‚ÄúAre we actually adding business value?‚Äù</li>
</ul>

<p>This narrative provides an honest look at the gap between ML theory and practice, offering insights for practitioners working to deliver meaningful value through machine learning systems.</p>

<hr />

<h2 id="chapter-1-the-setup">Chapter 1: The Setup</h2>

<p>Sarah stared at her screen, the glow reflecting off her coffee cup as she contemplated the task ahead. As a senior ML engineer at FinTech Solutions, she‚Äôd been tasked with implementing MLflow Model Registry to improve their model versioning and deployment workflow. What seemed like a straightforward technical implementation would soon evolve into something much more complex.</p>

<p>The company‚Äôs current ML pipeline was a patchwork of scripts, notebooks, and manual processes. Models were deployed through a combination of Jenkins jobs, Docker containers, and crossed fingers. Version control existed in theory but was inconsistently applied in practice.</p>

<p>‚ÄúThis should be straightforward,‚Äù she thought, pulling up the MLflow documentation. ‚ÄúRegistry, staging, production, done.‚Äù</p>

<p>But as any experienced practitioner knows, the gap between documentation and production reality can be vast.</p>

<h3 id="the-current-state">The Current State</h3>

<p>Their existing infrastructure consisted of:</p>
<ul>
  <li>Multiple Jupyter notebooks for model development</li>
  <li>Manual model serialization with pickle</li>
  <li>Ad-hoc versioning using git tags</li>
  <li>Deployment through custom Docker builds</li>
  <li>Monitoring through application logs and Grafana dashboards</li>
</ul>

<p>Sarah‚Äôs first task was to understand not just the technical requirements, but the organizational context that had led to this fragmented approach.</p>

<hr />

<h2 id="chapter-2-first-steps-with-mlflow">Chapter 2: First Steps with MLflow</h2>

<p>Sarah began by setting up a local MLflow tracking server. The installation was straightforward:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>mlflow
mlflow server <span class="nt">--backend-store-uri</span> sqlite:///mlflow.db <span class="nt">--default-artifact-root</span> ./artifacts
</code></pre></div></div>

<p>She started with a simple experiment, tracking her first model:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">mlflow</span>
<span class="kn">import</span> <span class="n">mlflow.sklearn</span>
<span class="kn">from</span> <span class="n">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="n">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="n">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span>

<span class="c1"># Start MLflow run
</span><span class="k">with</span> <span class="n">mlflow</span><span class="p">.</span><span class="nf">start_run</span><span class="p">():</span>
    <span class="c1"># Load and prepare data
</span>    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="nf">train_test_split</span><span class="p">(</span>
        <span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
    <span class="p">)</span>
    
    <span class="c1"># Train model
</span>    <span class="n">model</span> <span class="o">=</span> <span class="nc">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    
    <span class="c1"># Make predictions
</span>    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    
    <span class="c1"># Log parameters and metrics
</span>    <span class="n">mlflow</span><span class="p">.</span><span class="nf">log_param</span><span class="p">(</span><span class="sh">"</span><span class="s">n_estimators</span><span class="sh">"</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="p">.</span><span class="nf">log_param</span><span class="p">(</span><span class="sh">"</span><span class="s">random_state</span><span class="sh">"</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="p">.</span><span class="nf">log_metric</span><span class="p">(</span><span class="sh">"</span><span class="s">accuracy</span><span class="sh">"</span><span class="p">,</span> <span class="nf">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
    <span class="n">mlflow</span><span class="p">.</span><span class="nf">log_metric</span><span class="p">(</span><span class="sh">"</span><span class="s">precision</span><span class="sh">"</span><span class="p">,</span> <span class="nf">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="sh">'</span><span class="s">weighted</span><span class="sh">'</span><span class="p">))</span>
    <span class="n">mlflow</span><span class="p">.</span><span class="nf">log_metric</span><span class="p">(</span><span class="sh">"</span><span class="s">recall</span><span class="sh">"</span><span class="p">,</span> <span class="nf">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="sh">'</span><span class="s">weighted</span><span class="sh">'</span><span class="p">))</span>
    
    <span class="c1"># Log model
</span>    <span class="n">mlflow</span><span class="p">.</span><span class="n">sklearn</span><span class="p">.</span><span class="nf">log_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="sh">"</span><span class="s">random_forest_model</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>The MLflow UI provided an immediate improvement over their previous workflow. She could see all experiments, compare metrics, and examine model artifacts in one place.</p>

<h3 id="integrating-with-existing-workflow">Integrating with Existing Workflow</h3>

<p>The challenge wasn‚Äôt technical - it was organizational. The team had developed habits and workflows over months. Changing these required more than just new tools; it required changing mindsets.</p>

<p>Sarah scheduled a series of lunch-and-learns to demonstrate MLflow‚Äôs capabilities. She showed how experiment tracking could replace their spreadsheet-based approach to comparing model performance. The response was mixed - some team members were excited, others were skeptical about learning yet another tool.</p>

<hr />

<h2 id="chapter-3-discovering-the-model-registry">Chapter 3: Discovering the Model Registry</h2>

<p>After several weeks of successful experiment tracking, Sarah moved to the next phase: the Model Registry. This is where MLflow‚Äôs enterprise capabilities really shone.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">mlflow.sklearn</span>

<span class="c1"># Register a model
</span><span class="n">model_uri</span> <span class="o">=</span> <span class="sh">"</span><span class="s">runs:/{}/random_forest_model</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>
<span class="n">model_version</span> <span class="o">=</span> <span class="n">mlflow</span><span class="p">.</span><span class="nf">register_model</span><span class="p">(</span><span class="n">model_uri</span><span class="p">,</span> <span class="sh">"</span><span class="s">fraud_detection_model</span><span class="sh">"</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Model version </span><span class="si">{</span><span class="n">model_version</span><span class="p">.</span><span class="n">version</span><span class="si">}</span><span class="s"> registered</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>The Model Registry introduced a formal lifecycle for models:</p>
<ul>
  <li><strong>None</strong>: Newly registered models</li>
  <li><strong>Staging</strong>: Models being tested</li>
  <li><strong>Production</strong>: Models serving live traffic</li>
  <li><strong>Archived</strong>: Deprecated models</li>
</ul>

<p>This structure forced conversations about model governance that the team had been avoiding. Who decides when a model moves from staging to production? What testing is required? How do we handle rollbacks?</p>

<h3 id="creating-a-model-governance-process">Creating a Model Governance Process</h3>

<p>Sarah worked with the team to establish clear criteria for each stage:</p>

<p><strong>Staging Criteria:</strong></p>
<ul>
  <li>Model passes all unit tests</li>
  <li>Performance metrics meet minimum thresholds</li>
  <li>Feature drift analysis shows acceptable stability</li>
  <li>Peer review of model code completed</li>
</ul>

<p><strong>Production Criteria:</strong></p>
<ul>
  <li>A/B testing shows statistical significance</li>
  <li>Business stakeholders approve deployment</li>
  <li>Monitoring dashboards configured</li>
  <li>Rollback procedures documented</li>
</ul>

<p><strong>Example of stage transitions:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Promote to staging
</span><span class="n">client</span> <span class="o">=</span> <span class="n">mlflow</span><span class="p">.</span><span class="n">tracking</span><span class="p">.</span><span class="nc">MlflowClient</span><span class="p">()</span>
<span class="n">client</span><span class="p">.</span><span class="nf">transition_model_version_stage</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">fraud_detection_model</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">stage</span><span class="o">=</span><span class="sh">"</span><span class="s">Staging</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">archive_existing_versions</span><span class="o">=</span><span class="bp">False</span>
<span class="p">)</span>

<span class="c1"># Add description
</span><span class="n">client</span><span class="p">.</span><span class="nf">update_model_version</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">fraud_detection_model</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="sh">"</span><span class="s">Improved feature engineering with transaction velocity features</span><span class="sh">"</span>
<span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="chapter-4-production-deployment-integration">Chapter 4: Production Deployment Integration</h2>

<p>Integrating MLflow with their existing deployment pipeline required careful consideration. They used Kubernetes for orchestration, so Sarah created a deployment script that could pull models directly from the registry:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">mlflow.sklearn</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">kubernetes</span> <span class="kn">import</span> <span class="n">client</span><span class="p">,</span> <span class="n">config</span>

<span class="k">def</span> <span class="nf">deploy_model_to_k8s</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model_version</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="sh">"</span><span class="s">default</span><span class="sh">"</span><span class="p">):</span>
    <span class="c1"># Load model from registry
</span>    <span class="n">model_uri</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">models:/</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">model_version</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">mlflow</span><span class="p">.</span><span class="n">sklearn</span><span class="p">.</span><span class="nf">load_model</span><span class="p">(</span><span class="n">model_uri</span><span class="p">)</span>
    
    <span class="c1"># Create deployment configuration
</span>    <span class="n">config</span><span class="p">.</span><span class="nf">load_incluster_config</span><span class="p">()</span>  <span class="c1"># or load_kube_config() for local dev
</span>    
    <span class="n">apps_v1</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nc">AppsV1Api</span><span class="p">()</span>
    
    <span class="n">deployment</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nc">V1Deployment</span><span class="p">(</span>
        <span class="n">metadata</span><span class="o">=</span><span class="n">client</span><span class="p">.</span><span class="nc">V1ObjectMeta</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s">-v</span><span class="si">{</span><span class="n">model_version</span><span class="si">}</span><span class="sh">"</span><span class="p">),</span>
        <span class="n">spec</span><span class="o">=</span><span class="n">client</span><span class="p">.</span><span class="nc">V1DeploymentSpec</span><span class="p">(</span>
            <span class="n">replicas</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">selector</span><span class="o">=</span><span class="n">client</span><span class="p">.</span><span class="nc">V1LabelSelector</span><span class="p">(</span>
                <span class="n">match_labels</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">app</span><span class="sh">"</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">version</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">model_version</span><span class="p">)}</span>
            <span class="p">),</span>
            <span class="n">template</span><span class="o">=</span><span class="n">client</span><span class="p">.</span><span class="nc">V1PodTemplateSpec</span><span class="p">(</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">client</span><span class="p">.</span><span class="nc">V1ObjectMeta</span><span class="p">(</span>
                    <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">app</span><span class="sh">"</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">version</span><span class="sh">"</span><span class="p">:</span> <span class="nf">str</span><span class="p">(</span><span class="n">model_version</span><span class="p">)}</span>
                <span class="p">),</span>
                <span class="n">spec</span><span class="o">=</span><span class="n">client</span><span class="p">.</span><span class="nc">V1PodSpec</span><span class="p">(</span>
                    <span class="n">containers</span><span class="o">=</span><span class="p">[</span>
                        <span class="n">client</span><span class="p">.</span><span class="nc">V1Container</span><span class="p">(</span>
                            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">model-server</span><span class="sh">"</span><span class="p">,</span>
                            <span class="n">image</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">mlflow-server:</span><span class="si">{</span><span class="n">model_version</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
                            <span class="n">ports</span><span class="o">=</span><span class="p">[</span><span class="n">client</span><span class="p">.</span><span class="nc">V1ContainerPort</span><span class="p">(</span><span class="n">container_port</span><span class="o">=</span><span class="mi">8080</span><span class="p">)],</span>
                            <span class="n">env</span><span class="o">=</span><span class="p">[</span>
                                <span class="n">client</span><span class="p">.</span><span class="nc">V1EnvVar</span><span class="p">(</span>
                                    <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">MODEL_URI</span><span class="sh">"</span><span class="p">,</span>
                                    <span class="n">value</span><span class="o">=</span><span class="n">model_uri</span>
                                <span class="p">)</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    
    <span class="n">apps_v1</span><span class="p">.</span><span class="nf">create_namespaced_deployment</span><span class="p">(</span>
        <span class="n">body</span><span class="o">=</span><span class="n">deployment</span><span class="p">,</span>
        <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span>
    <span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Deployed </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s"> version </span><span class="si">{</span><span class="n">model_version</span><span class="si">}</span><span class="s"> to Kubernetes</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="handling-model-serving">Handling Model Serving</h3>

<p>For model serving, they integrated with their existing FastAPI infrastructure:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
<span class="kn">from</span> <span class="n">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">import</span> <span class="n">mlflow.sklearn</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="n">app</span> <span class="o">=</span> <span class="nc">FastAPI</span><span class="p">()</span>

<span class="c1"># Load model at startup
</span><span class="n">MODEL_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_NAME</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">fraud_detection_model</span><span class="sh">"</span><span class="p">)</span>
<span class="n">MODEL_VERSION</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">"</span><span class="s">MODEL_VERSION</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">latest</span><span class="sh">"</span><span class="p">)</span>
<span class="n">model_uri</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">models:/</span><span class="si">{</span><span class="n">MODEL_NAME</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">MODEL_VERSION</span><span class="si">}</span><span class="sh">"</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">mlflow</span><span class="p">.</span><span class="n">sklearn</span><span class="p">.</span><span class="nf">load_model</span><span class="p">(</span><span class="n">model_uri</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Loaded model </span><span class="si">{</span><span class="n">MODEL_NAME</span><span class="si">}</span><span class="s"> version </span><span class="si">{</span><span class="n">MODEL_VERSION</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed to load model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">PredictionRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">PredictionResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">probability</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="n">model_version</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@app.post</span><span class="p">(</span><span class="sh">"</span><span class="s">/predict</span><span class="sh">"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PredictionResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">PredictionRequest</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">503</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sh">"</span><span class="s">Model not available</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Convert to DataFrame for prediction
</span>        <span class="n">features_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">([</span><span class="n">request</span><span class="p">.</span><span class="n">features</span><span class="p">])</span>
        
        <span class="c1"># Make prediction
</span>        <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">features_df</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="nf">predict_proba</span><span class="p">(</span><span class="n">features_df</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">tolist</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="nc">PredictionResponse</span><span class="p">(</span>
            <span class="n">prediction</span><span class="o">=</span><span class="nf">float</span><span class="p">(</span><span class="n">prediction</span><span class="p">),</span>
            <span class="n">probability</span><span class="o">=</span><span class="n">probabilities</span><span class="p">,</span>
            <span class="n">model_version</span><span class="o">=</span><span class="n">MODEL_VERSION</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">Prediction failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="nd">@app.get</span><span class="p">(</span><span class="sh">"</span><span class="s">/health</span><span class="sh">"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">health_check</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">healthy</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">model_loaded</span><span class="sh">"</span><span class="p">:</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="chapter-5-the-reality-of-feature-engineering">Chapter 5: The Reality of Feature Engineering</h2>

<p>As Sarah delved deeper into the model registry implementation, she encountered the real complexity of their ML system: feature engineering. The fraud detection model relied on dozens of features, each with its own computation logic and dependencies.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calculate_transaction_velocity</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">transaction_time</span><span class="p">,</span> <span class="n">window_hours</span><span class="o">=</span><span class="mi">24</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Calculate transaction velocity for fraud detection</span><span class="sh">"""</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">transaction_time</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="nf">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">window_hours</span><span class="p">)</span>
    
    <span class="c1"># Query transaction history
</span>    <span class="n">query</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
    SELECT COUNT(*) as transaction_count,
           SUM(amount) as total_amount,
           AVG(amount) as avg_amount
    FROM transactions 
    WHERE user_id = %s 
    AND transaction_time BETWEEN %s AND %s
    </span><span class="sh">"""</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="nf">execute_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="n">user_id</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">tx_velocity_24h</span><span class="sh">'</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">transaction_count</span><span class="sh">'</span><span class="p">],</span>
        <span class="sh">'</span><span class="s">amount_velocity_24h</span><span class="sh">'</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">total_amount</span><span class="sh">'</span><span class="p">],</span>
        <span class="sh">'</span><span class="s">avg_amount_24h</span><span class="sh">'</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">avg_amount</span><span class="sh">'</span><span class="p">]</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">calculate_merchant_risk_score</span><span class="p">(</span><span class="n">merchant_id</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Calculate merchant risk based on historical fraud rates</span><span class="sh">"""</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
    SELECT 
        COUNT(*) as total_transactions,
        SUM(CASE WHEN is_fraud = 1 THEN 1 ELSE 0 END) as fraud_count,
        AVG(amount) as avg_transaction_amount
    FROM transactions 
    WHERE merchant_id = %s 
    AND transaction_time &gt;= NOW() - INTERVAL 30 DAY
    </span><span class="sh">"""</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="nf">execute_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="n">merchant_id</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">total_transactions</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="c1"># Not enough data for reliable scoring
</span>        <span class="k">return</span> <span class="mf">0.5</span>  <span class="c1"># Neutral score
</span>    
    <span class="n">fraud_rate</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">fraud_count</span><span class="sh">'</span><span class="p">]</span> <span class="o">/</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">total_transactions</span><span class="sh">'</span><span class="p">]</span>
    
    <span class="c1"># Normalize to 0-1 scale
</span>    <span class="k">return</span> <span class="nf">min</span><span class="p">(</span><span class="n">fraud_rate</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extract_geolocation_features</span><span class="p">(</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">user_location</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Extract geolocation-based features</span><span class="sh">"""</span>
    <span class="n">ip_location</span> <span class="o">=</span> <span class="nf">geolocate_ip</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ip_location</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">user_location</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">distance_from_home</span><span class="sh">'</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">location_risk_score</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">is_vpn</span><span class="sh">'</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>
    
    <span class="c1"># Calculate distance
</span>    <span class="n">distance</span> <span class="o">=</span> <span class="nf">calculate_distance</span><span class="p">(</span><span class="n">ip_location</span><span class="p">,</span> <span class="n">user_location</span><span class="p">)</span>
    
    <span class="c1"># Location risk based on historical fraud patterns
</span>    <span class="n">location_risk</span> <span class="o">=</span> <span class="nf">get_location_risk_score</span><span class="p">(</span><span class="n">ip_location</span><span class="p">)</span>
    
    <span class="c1"># VPN detection
</span>    <span class="n">is_vpn</span> <span class="o">=</span> <span class="nf">detect_vpn</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">distance_from_home</span><span class="sh">'</span><span class="p">:</span> <span class="n">distance</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">location_risk_score</span><span class="sh">'</span><span class="p">:</span> <span class="n">location_risk</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">is_vpn</span><span class="sh">'</span><span class="p">:</span> <span class="n">is_vpn</span>
    <span class="p">}</span>
</code></pre></div></div>

<h3 id="the-feature-pipeline-challenge">The Feature Pipeline Challenge</h3>

<p>Each feature had different latency requirements and data dependencies. Some could be computed in real-time, others required batch processing. This created a complex feature pipeline:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FeaturePipeline</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">realtime_features</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sh">'</span><span class="s">transaction_amount</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">merchant_category</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">hour_of_day</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">day_of_week</span><span class="sh">'</span>
        <span class="p">]</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">batch_features</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sh">'</span><span class="s">user_tx_velocity_24h</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">user_avg_amount_7d</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">merchant_risk_score</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">location_risk_score</span><span class="sh">'</span>
        <span class="p">]</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">feature_store</span> <span class="o">=</span> <span class="nc">FeatureStore</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">transaction_data</span><span class="p">):</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Extract real-time features
</span>        <span class="n">features</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_extract_realtime_features</span><span class="p">(</span><span class="n">transaction_data</span><span class="p">))</span>
        
        <span class="c1"># Lookup pre-computed batch features
</span>        <span class="n">features</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_lookup_batch_features</span><span class="p">(</span><span class="n">transaction_data</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">features</span>
    
    <span class="k">def</span> <span class="nf">_extract_realtime_features</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">transaction_data</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">amount</span><span class="sh">'</span><span class="p">:</span> <span class="n">transaction_data</span><span class="p">[</span><span class="sh">'</span><span class="s">amount</span><span class="sh">'</span><span class="p">],</span>
            <span class="sh">'</span><span class="s">merchant_category</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">_encode_category</span><span class="p">(</span><span class="n">transaction_data</span><span class="p">[</span><span class="sh">'</span><span class="s">merchant_category</span><span class="sh">'</span><span class="p">]),</span>
            <span class="sh">'</span><span class="s">hour_of_day</span><span class="sh">'</span><span class="p">:</span> <span class="n">transaction_data</span><span class="p">[</span><span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">].</span><span class="n">hour</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">day_of_week</span><span class="sh">'</span><span class="p">:</span> <span class="n">transaction_data</span><span class="p">[</span><span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">].</span><span class="nf">weekday</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_lookup_batch_features</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">transaction_data</span><span class="p">):</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">transaction_data</span><span class="p">[</span><span class="sh">'</span><span class="s">user_id</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">merchant_id</span> <span class="o">=</span> <span class="n">transaction_data</span><span class="p">[</span><span class="sh">'</span><span class="s">merchant_id</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="c1"># These would be pre-computed in batch jobs
</span>        <span class="n">user_features</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">feature_store</span><span class="p">.</span><span class="nf">get_user_features</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">merchant_features</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">feature_store</span><span class="p">.</span><span class="nf">get_merchant_features</span><span class="p">(</span><span class="n">merchant_id</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">user_features</span><span class="p">,</span>
            <span class="o">**</span><span class="n">merchant_features</span>
        <span class="p">}</span>
</code></pre></div></div>

<h3 id="version-control-for-features">Version Control for Features</h3>

<p>One of Sarah‚Äôs biggest challenges was versioning the feature engineering logic alongside the models. Changes to feature calculations could break existing models, but the business needed to evolve features to combat new fraud patterns.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FeatureVersion</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="sh">"</span><span class="s">v1</span><span class="sh">"</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
        <span class="n">self</span><span class="p">.</span><span class="n">feature_extractors</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_load_extractors</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_load_extractors</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="sh">"</span><span class="s">v1</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">transaction_velocity</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">_calculate_velocity_v1</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">merchant_risk</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">_calculate_merchant_risk_v1</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">version</span> <span class="o">==</span> <span class="sh">"</span><span class="s">v2</span><span class="sh">"</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">transaction_velocity</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">_calculate_velocity_v2</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">merchant_risk</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">_calculate_merchant_risk_v2</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unknown feature version: </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_calculate_velocity_v1</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="c1"># Original implementation - 24 hour window
</span>        <span class="k">return</span> <span class="nf">calculate_transaction_velocity</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">window_hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_calculate_velocity_v2</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="c1"># Enhanced implementation - multiple time windows
</span>        <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">168</span><span class="p">]:</span>  <span class="c1"># 1h, 6h, 24h, 1week
</span>            <span class="n">window_features</span> <span class="o">=</span> <span class="nf">calculate_transaction_velocity</span><span class="p">(</span>
                <span class="n">user_id</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">window_hours</span><span class="o">=</span><span class="n">window</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">window_features</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                <span class="n">features</span><span class="p">[</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s">h</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">features</span>
</code></pre></div></div>

<hr />

<h2 id="chapter-6-ab-testing-and-model-evaluation">Chapter 6: A/B Testing and Model Evaluation</h2>

<p>With the model registry in place, Sarah turned her attention to A/B testing. The goal was to deploy new models gradually and measure their impact on business metrics, not just ML metrics.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ModelABTest</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_a_name</span><span class="p">,</span> <span class="n">model_b_name</span><span class="p">,</span> <span class="n">traffic_split</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model_a</span> <span class="o">=</span> <span class="n">mlflow</span><span class="p">.</span><span class="n">sklearn</span><span class="p">.</span><span class="nf">load_model</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">models:/</span><span class="si">{</span><span class="n">model_a_name</span><span class="si">}</span><span class="s">/Production</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model_b</span> <span class="o">=</span> <span class="n">mlflow</span><span class="p">.</span><span class="n">sklearn</span><span class="p">.</span><span class="nf">load_model</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">models:/</span><span class="si">{</span><span class="n">model_b_name</span><span class="si">}</span><span class="s">/Staging</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">traffic_split</span> <span class="o">=</span> <span class="n">traffic_split</span>
        <span class="n">self</span><span class="p">.</span><span class="n">test_start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">route_prediction</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
        <span class="c1"># Consistent routing based on request hash
</span>        <span class="n">hash_value</span> <span class="o">=</span> <span class="nf">hash</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">))</span> <span class="o">%</span> <span class="mi">100</span>
        
        <span class="k">if</span> <span class="n">hash_value</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">traffic_split</span> <span class="o">*</span> <span class="mi">100</span><span class="p">:</span>
            <span class="c1"># Route to model B (new model)
</span>            <span class="n">prediction</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model_b</span><span class="p">.</span><span class="nf">predict</span><span class="p">([</span><span class="n">features</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">model_version</span> <span class="o">=</span> <span class="sh">"</span><span class="s">B</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Route to model A (current production)
</span>            <span class="n">prediction</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">model_a</span><span class="p">.</span><span class="nf">predict</span><span class="p">([</span><span class="n">features</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">model_version</span> <span class="o">=</span> <span class="sh">"</span><span class="s">A</span><span class="sh">"</span>
        
        <span class="c1"># Log for analysis
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">_log_prediction</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">model_version</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">prediction</span>
    
    <span class="k">def</span> <span class="nf">_log_prediction</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">model_version</span><span class="p">):</span>
        <span class="n">log_entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">(),</span>
            <span class="sh">'</span><span class="s">request_id</span><span class="sh">'</span><span class="p">:</span> <span class="n">request_id</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">features</span><span class="sh">'</span><span class="p">:</span> <span class="n">features</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">prediction</span><span class="sh">'</span><span class="p">:</span> <span class="n">prediction</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">model_version</span><span class="sh">'</span><span class="p">:</span> <span class="n">model_version</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">test_start_time</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">test_start_time</span>
        <span class="p">}</span>
        
        <span class="c1"># Send to logging system for later analysis
</span>        <span class="nf">send_to_analytics</span><span class="p">(</span><span class="n">log_entry</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="measuring-business-impact">Measuring Business Impact</h3>

<p>The real challenge wasn‚Äôt technical - it was defining success metrics. ML metrics like precision and recall were important, but the business cared about different outcomes:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">analyze_ab_test_results</span><span class="p">(</span><span class="n">test_start_time</span><span class="p">,</span> <span class="n">test_duration_hours</span><span class="o">=</span><span class="mi">168</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Analyze A/B test results over the specified duration</span><span class="sh">"""</span>
    
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">test_start_time</span> <span class="o">+</span> <span class="nf">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">test_duration_hours</span><span class="p">)</span>
    
    <span class="c1"># Query prediction logs
</span>    <span class="n">predictions_query</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
    SELECT 
        model_version,
        COUNT(*) as prediction_count,
        AVG(prediction) as avg_fraud_score
    FROM prediction_logs 
    WHERE timestamp BETWEEN %s AND %s
    GROUP BY model_version
    </span><span class="sh">"""</span>
    
    <span class="c1"># Query actual outcomes (with delay for fraud confirmation)
</span>    <span class="n">outcomes_query</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
    SELECT 
        p.model_version,
        COUNT(*) as total_transactions,
        SUM(CASE WHEN t.is_fraud = 1 THEN 1 ELSE 0 END) as fraud_count,
        SUM(CASE WHEN p.prediction &gt;= 0.5 AND t.is_fraud = 0 THEN 1 ELSE 0 END) as false_positives,
        SUM(CASE WHEN p.prediction &lt; 0.5 AND t.is_fraud = 1 THEN 1 ELSE 0 END) as false_negatives,
        SUM(t.amount) as total_transaction_volume,
        SUM(CASE WHEN p.prediction &gt;= 0.5 THEN t.amount ELSE 0 END) as blocked_volume
    FROM prediction_logs p
    JOIN transactions t ON p.request_id = t.id
    WHERE p.timestamp BETWEEN %s AND %s
    AND t.outcome_confirmed = 1  -- Only confirmed outcomes
    GROUP BY p.model_version
    </span><span class="sh">"""</span>
    
    <span class="n">prediction_results</span> <span class="o">=</span> <span class="nf">execute_query</span><span class="p">(</span><span class="n">predictions_query</span><span class="p">,</span> <span class="p">[</span><span class="n">test_start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">])</span>
    <span class="n">outcome_results</span> <span class="o">=</span> <span class="nf">execute_query</span><span class="p">(</span><span class="n">outcomes_query</span><span class="p">,</span> <span class="p">[</span><span class="n">test_start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">])</span>
    
    <span class="c1"># Calculate business metrics
</span>    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">outcome_results</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">model_version</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="c1"># Calculate traditional ML metrics
</span>        <span class="n">precision</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">fraud_count</span><span class="sh">'</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">false_negatives</span><span class="sh">'</span><span class="p">])</span> <span class="o">/</span> <span class="nf">max</span><span class="p">(</span>
            <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">fraud_count</span><span class="sh">'</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">false_negatives</span><span class="sh">'</span><span class="p">]</span> <span class="o">+</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">false_positives</span><span class="sh">'</span><span class="p">],</span> <span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">recall</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">fraud_count</span><span class="sh">'</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">false_negatives</span><span class="sh">'</span><span class="p">])</span> <span class="o">/</span> <span class="nf">max</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">fraud_count</span><span class="sh">'</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Calculate business metrics
</span>        <span class="n">false_positive_rate</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">false_positives</span><span class="sh">'</span><span class="p">]</span> <span class="o">/</span> <span class="nf">max</span><span class="p">(</span>
            <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">total_transactions</span><span class="sh">'</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">fraud_count</span><span class="sh">'</span><span class="p">],</span> <span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">blocked_legitimate_volume</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">false_positives</span><span class="sh">'</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">total_transaction_volume</span><span class="sh">'</span><span class="p">]</span> <span class="o">/</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">total_transactions</span><span class="sh">'</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="n">metrics</span><span class="p">[</span><span class="n">version</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">precision</span><span class="sh">'</span><span class="p">:</span> <span class="n">precision</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">recall</span><span class="sh">'</span><span class="p">:</span> <span class="n">recall</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">false_positive_rate</span><span class="sh">'</span><span class="p">:</span> <span class="n">false_positive_rate</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">blocked_legitimate_volume</span><span class="sh">'</span><span class="p">:</span> <span class="n">blocked_legitimate_volume</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">total_predictions</span><span class="sh">'</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">total_transactions</span><span class="sh">'</span><span class="p">]</span>
        <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">metrics</span>

<span class="k">def</span> <span class="nf">calculate_statistical_significance</span><span class="p">(</span><span class="n">metrics_a</span><span class="p">,</span> <span class="n">metrics_b</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Calculate statistical significance of the difference between models</span><span class="sh">"""</span>
    
    <span class="c1"># This is a simplified version - in practice, you'd want more robust statistical testing
</span>    <span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
    
    <span class="c1"># Extract the metric values
</span>    <span class="n">value_a</span> <span class="o">=</span> <span class="n">metrics_a</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span>
    <span class="n">value_b</span> <span class="o">=</span> <span class="n">metrics_b</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span>
    
    <span class="c1"># Sample sizes
</span>    <span class="n">n_a</span> <span class="o">=</span> <span class="n">metrics_a</span><span class="p">[</span><span class="sh">'</span><span class="s">total_predictions</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">n_b</span> <span class="o">=</span> <span class="n">metrics_b</span><span class="p">[</span><span class="sh">'</span><span class="s">total_predictions</span><span class="sh">'</span><span class="p">]</span>
    
    <span class="c1"># For rates/proportions, use proportion z-test
</span>    <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">precision</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">recall</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">false_positive_rate</span><span class="sh">'</span><span class="p">]:</span>
        <span class="c1"># Convert to counts for proportion test
</span>        <span class="n">count_a</span> <span class="o">=</span> <span class="n">value_a</span> <span class="o">*</span> <span class="n">n_a</span>
        <span class="n">count_b</span> <span class="o">=</span> <span class="n">value_b</span> <span class="o">*</span> <span class="n">n_b</span>
        
        <span class="n">stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="nf">proportions_ztest</span><span class="p">([</span><span class="n">count_a</span><span class="p">,</span> <span class="n">count_b</span><span class="p">],</span> <span class="p">[</span><span class="n">n_a</span><span class="p">,</span> <span class="n">n_b</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">statistic</span><span class="sh">'</span><span class="p">:</span> <span class="n">stat</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">p_value</span><span class="sh">'</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">significant</span><span class="sh">'</span><span class="p">:</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">effect_size</span><span class="sh">'</span><span class="p">:</span> <span class="n">value_b</span> <span class="o">-</span> <span class="n">value_a</span>
        <span class="p">}</span>
    
    <span class="c1"># For continuous metrics, use t-test (simplified)
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># This is oversimplified - you'd need the actual distributions
</span>        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">statistic</span><span class="sh">'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">p_value</span><span class="sh">'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">significant</span><span class="sh">'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">effect_size</span><span class="sh">'</span><span class="p">:</span> <span class="n">value_b</span> <span class="o">-</span> <span class="n">value_a</span>
        <span class="p">}</span>
</code></pre></div></div>

<h3 id="the-challenge-of-delayed-feedback">The Challenge of Delayed Feedback</h3>

<p>One of the biggest challenges in fraud detection is the delayed feedback loop. It could take days or weeks to confirm whether a transaction was actually fraudulent. This made A/B testing complex:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DelayedFeedbackAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">prediction_table</span><span class="p">,</span> <span class="n">outcome_table</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">prediction_table</span> <span class="o">=</span> <span class="n">prediction_table</span>
        <span class="n">self</span><span class="p">.</span><span class="n">outcome_table</span> <span class="o">=</span> <span class="n">outcome_table</span>
    
    <span class="k">def</span> <span class="nf">analyze_with_partial_feedback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">test_start_time</span><span class="p">,</span> <span class="n">analysis_time</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Analyze test results with only partial feedback available</span><span class="sh">"""</span>
        
        <span class="c1"># Get all predictions made during test
</span>        <span class="n">predictions</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get_predictions</span><span class="p">(</span><span class="n">test_start_time</span><span class="p">,</span> <span class="n">analysis_time</span><span class="p">)</span>
        
        <span class="c1"># Get confirmed outcomes (subset of all predictions)
</span>        <span class="n">confirmed_outcomes</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get_confirmed_outcomes</span><span class="p">(</span><span class="n">test_start_time</span><span class="p">,</span> <span class="n">analysis_time</span><span class="p">)</span>
        
        <span class="c1"># Estimate metrics with confidence intervals
</span>        <span class="n">estimated_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">model_version</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">version_predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">predictions</span><span class="p">[</span><span class="sh">'</span><span class="s">model_version</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">model_version</span><span class="p">]</span>
            <span class="n">version_outcomes</span> <span class="o">=</span> <span class="n">confirmed_outcomes</span><span class="p">[</span><span class="n">confirmed_outcomes</span><span class="p">[</span><span class="sh">'</span><span class="s">model_version</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">model_version</span><span class="p">]</span>
            
            <span class="c1"># Calculate metrics on confirmed subset
</span>            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">version_outcomes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">confirmed_precision</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_calculate_precision</span><span class="p">(</span><span class="n">version_outcomes</span><span class="p">)</span>
                <span class="n">confirmed_recall</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_calculate_recall</span><span class="p">(</span><span class="n">version_outcomes</span><span class="p">)</span>
                
                <span class="c1"># Estimate confidence intervals
</span>                <span class="n">precision_ci</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_bootstrap_confidence_interval</span><span class="p">(</span>
                    <span class="n">version_outcomes</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_calculate_precision</span>
                <span class="p">)</span>
                <span class="n">recall_ci</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_bootstrap_confidence_interval</span><span class="p">(</span>
                    <span class="n">version_outcomes</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_calculate_recall</span>
                <span class="p">)</span>
                
                <span class="n">estimated_metrics</span><span class="p">[</span><span class="n">model_version</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">'</span><span class="s">confirmed_precision</span><span class="sh">'</span><span class="p">:</span> <span class="n">confirmed_precision</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">confirmed_recall</span><span class="sh">'</span><span class="p">:</span> <span class="n">confirmed_recall</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">precision_ci</span><span class="sh">'</span><span class="p">:</span> <span class="n">precision_ci</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">recall_ci</span><span class="sh">'</span><span class="p">:</span> <span class="n">recall_ci</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">confirmation_rate</span><span class="sh">'</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">version_outcomes</span><span class="p">)</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">version_predictions</span><span class="p">)</span>
                <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">estimated_metrics</span>
    
    <span class="k">def</span> <span class="nf">_bootstrap_confidence_interval</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">metric_func</span><span class="p">,</span> <span class="n">n_bootstrap</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Calculate bootstrap confidence interval for a metric</span><span class="sh">"""</span>
        <span class="n">bootstrap_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n_bootstrap</span><span class="p">):</span>
            <span class="c1"># Resample with replacement
</span>            <span class="n">bootstrap_sample</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">bootstrap_metric</span> <span class="o">=</span> <span class="nf">metric_func</span><span class="p">(</span><span class="n">bootstrap_sample</span><span class="p">)</span>
            <span class="n">bootstrap_metrics</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">bootstrap_metric</span><span class="p">)</span>
        
        <span class="c1"># Calculate confidence interval
</span>        <span class="n">lower_percentile</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">upper_percentile</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="n">ci_lower</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">percentile</span><span class="p">(</span><span class="n">bootstrap_metrics</span><span class="p">,</span> <span class="n">lower_percentile</span><span class="p">)</span>
        <span class="n">ci_upper</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">percentile</span><span class="p">(</span><span class="n">bootstrap_metrics</span><span class="p">,</span> <span class="n">upper_percentile</span><span class="p">)</span>
        
        <span class="nf">return </span><span class="p">(</span><span class="n">ci_lower</span><span class="p">,</span> <span class="n">ci_upper</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="chapter-7-the-performance-paradox">Chapter 7: The Performance Paradox</h2>

<p>Three months into the MLflow implementation, Sarah faced an unexpected challenge. The new model registry and versioning system were working perfectly from a technical standpoint, but the business metrics were confusing.</p>

<p>Model B, which had better precision and recall on the test set, was performing worse in production according to some business metrics. Customer complaints had increased, and the fraud prevention team was questioning the new approach.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">investigate_performance_discrepancy</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">Investigate why Model B performs worse despite better ML metrics</span><span class="sh">"""</span>
    
    <span class="c1"># Compare test set performance vs production performance
</span>    <span class="n">test_metrics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">model_a</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">precision</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.92</span><span class="p">,</span> <span class="sh">'</span><span class="s">recall</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.88</span><span class="p">,</span> <span class="sh">'</span><span class="s">f1</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.90</span><span class="p">},</span>
        <span class="sh">'</span><span class="s">model_b</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">precision</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.94</span><span class="p">,</span> <span class="sh">'</span><span class="s">recall</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.91</span><span class="p">,</span> <span class="sh">'</span><span class="s">f1</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.92</span><span class="p">}</span>
    <span class="p">}</span>
    
    <span class="n">production_metrics</span> <span class="o">=</span> <span class="nf">analyze_ab_test_results</span><span class="p">(</span><span class="n">test_start_time</span><span class="p">,</span> <span class="n">test_duration_hours</span><span class="o">=</span><span class="mi">720</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Test Set Performance:</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">test_metrics</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">metrics</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Production Performance:</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">production_metrics</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Model </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s">:</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Precision: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">precision</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Recall: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">recall</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  False Positive Rate: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">false_positive_rate</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  Blocked Legitimate Volume: $</span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">blocked_legitimate_volume</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">,.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># The revelation: Model B was more aggressive, leading to more false positives
</span>    <span class="c1"># in edge cases not well represented in the test set
</span></code></pre></div></div>

<h3 id="data-drift-analysis">Data Drift Analysis</h3>

<p>Sarah suspected data drift - the production data distribution had changed since the model was trained. She implemented monitoring to track this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">scipy.stats</span> <span class="k">as</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="n">evidently</span> <span class="kn">import</span> <span class="n">ColumnMapping</span>
<span class="kn">from</span> <span class="n">evidently.model_profile</span> <span class="kn">import</span> <span class="n">Profile</span>
<span class="kn">from</span> <span class="n">evidently.model_profile.sections</span> <span class="kn">import</span> <span class="n">DataDriftProfileSection</span>

<span class="k">class</span> <span class="nc">DataDriftMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reference_data</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">reference_data</span> <span class="o">=</span> <span class="n">reference_data</span>
        <span class="n">self</span><span class="p">.</span><span class="n">drift_threshold</span> <span class="o">=</span> <span class="mf">0.1</span>
    
    <span class="k">def</span> <span class="nf">check_drift</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">current_data</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Check for data drift using multiple methods</span><span class="sh">"""</span>
        
        <span class="n">drift_results</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Statistical tests for numerical features
</span>        <span class="n">numerical_features</span> <span class="o">=</span> <span class="n">current_data</span><span class="p">.</span><span class="nf">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">number</span><span class="p">]).</span><span class="n">columns</span>
        
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">numerical_features</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">reference_data</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="c1"># Kolmogorov-Smirnov test
</span>                <span class="n">ks_statistic</span><span class="p">,</span> <span class="n">ks_p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="nf">ks_2samp</span><span class="p">(</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">reference_data</span><span class="p">[</span><span class="n">feature</span><span class="p">].</span><span class="nf">dropna</span><span class="p">(),</span>
                    <span class="n">current_data</span><span class="p">[</span><span class="n">feature</span><span class="p">].</span><span class="nf">dropna</span><span class="p">()</span>
                <span class="p">)</span>
                
                <span class="c1"># Population Stability Index
</span>                <span class="n">psi</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_calculate_psi</span><span class="p">(</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">reference_data</span><span class="p">[</span><span class="n">feature</span><span class="p">],</span>
                    <span class="n">current_data</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span>
                <span class="p">)</span>
                
                <span class="n">drift_results</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">'</span><span class="s">ks_statistic</span><span class="sh">'</span><span class="p">:</span> <span class="n">ks_statistic</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">ks_p_value</span><span class="sh">'</span><span class="p">:</span> <span class="n">ks_p_value</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">ks_drift_detected</span><span class="sh">'</span><span class="p">:</span> <span class="n">ks_p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">psi</span><span class="sh">'</span><span class="p">:</span> <span class="n">psi</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">psi_drift_detected</span><span class="sh">'</span><span class="p">:</span> <span class="n">psi</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">drift_threshold</span>
                <span class="p">}</span>
        
        <span class="c1"># Categorical features
</span>        <span class="n">categorical_features</span> <span class="o">=</span> <span class="n">current_data</span><span class="p">.</span><span class="nf">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">object</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">category</span><span class="sh">'</span><span class="p">]).</span><span class="n">columns</span>
        
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">categorical_features</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">reference_data</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="c1"># Chi-square test for categorical distributions
</span>                <span class="n">ref_counts</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">reference_data</span><span class="p">[</span><span class="n">feature</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">()</span>
                <span class="n">curr_counts</span> <span class="o">=</span> <span class="n">current_data</span><span class="p">[</span><span class="n">feature</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">()</span>
                
                <span class="c1"># Align the categories
</span>                <span class="n">all_categories</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">ref_counts</span><span class="p">.</span><span class="n">index</span><span class="p">)</span> <span class="o">|</span> <span class="nf">set</span><span class="p">(</span><span class="n">curr_counts</span><span class="p">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">ref_aligned</span> <span class="o">=</span> <span class="p">[</span><span class="n">ref_counts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">all_categories</span><span class="p">]</span>
                <span class="n">curr_aligned</span> <span class="o">=</span> <span class="p">[</span><span class="n">curr_counts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">all_categories</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="nf">sum</span><span class="p">(</span><span class="n">ref_aligned</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nf">sum</span><span class="p">(</span><span class="n">curr_aligned</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">chi2_stat</span><span class="p">,</span> <span class="n">chi2_p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="nf">chisquare</span><span class="p">(</span><span class="n">curr_aligned</span><span class="p">,</span> <span class="n">ref_aligned</span><span class="p">)</span>
                    
                    <span class="n">drift_results</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sh">'</span><span class="s">chi2_statistic</span><span class="sh">'</span><span class="p">:</span> <span class="n">chi2_stat</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">chi2_p_value</span><span class="sh">'</span><span class="p">:</span> <span class="n">chi2_p_value</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">chi2_drift_detected</span><span class="sh">'</span><span class="p">:</span> <span class="n">chi2_p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span>
                    <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">drift_results</span>
    
    <span class="k">def</span> <span class="nf">_calculate_psi</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">buckets</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Calculate Population Stability Index</span><span class="sh">"""</span>
        
        <span class="c1"># Create bins based on reference data
</span>        <span class="n">_</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">histogram</span><span class="p">(</span><span class="n">reference</span><span class="p">.</span><span class="nf">dropna</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="n">buckets</span><span class="p">)</span>
        
        <span class="c1"># Calculate proportions for each dataset
</span>        <span class="n">ref_props</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">histogram</span><span class="p">(</span><span class="n">reference</span><span class="p">.</span><span class="nf">dropna</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">)</span>
        <span class="n">curr_props</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">histogram</span><span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="nf">dropna</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">)</span>
        
        <span class="c1"># Convert to proportions
</span>        <span class="n">ref_props</span> <span class="o">=</span> <span class="n">ref_props</span> <span class="o">/</span> <span class="n">ref_props</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>
        <span class="n">curr_props</span> <span class="o">=</span> <span class="n">curr_props</span> <span class="o">/</span> <span class="n">curr_props</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>
        
        <span class="c1"># Calculate PSI
</span>        <span class="n">psi</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ref_prop</span><span class="p">,</span> <span class="n">curr_prop</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">ref_props</span><span class="p">,</span> <span class="n">curr_props</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ref_prop</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">curr_prop</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">psi</span> <span class="o">+=</span> <span class="p">(</span><span class="n">curr_prop</span> <span class="o">-</span> <span class="n">ref_prop</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">curr_prop</span> <span class="o">/</span> <span class="n">ref_prop</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">psi</span>
</code></pre></div></div>

<h3 id="model-performance-monitoring">Model Performance Monitoring</h3>

<p>Sarah also implemented comprehensive model performance monitoring:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ModelPerformanceMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">baseline_metrics</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_load_baseline_metrics</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">monitor_real_time_performance</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Monitor model performance in real-time</span><span class="sh">"""</span>
        
        <span class="c1"># Get recent predictions and outcomes
</span>        <span class="n">recent_data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get_recent_data</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">recent_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1"># Not enough data
</span>            <span class="k">return</span> <span class="bp">None</span>
        
        <span class="c1"># Calculate current metrics
</span>        <span class="n">current_metrics</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_calculate_metrics</span><span class="p">(</span><span class="n">recent_data</span><span class="p">)</span>
        
        <span class="c1"># Compare with baseline
</span>        <span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">current_value</span> <span class="ow">in</span> <span class="n">current_metrics</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">baseline_value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">baseline_metrics</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">baseline_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">relative_change</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_value</span> <span class="o">-</span> <span class="n">baseline_value</span><span class="p">)</span> <span class="o">/</span> <span class="n">baseline_value</span>
                
                <span class="c1"># Alert if performance drops by more than 5%
</span>                <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">precision</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">recall</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">relative_change</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">:</span>
                    <span class="n">alerts</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">'</span><span class="s">metric</span><span class="sh">'</span><span class="p">:</span> <span class="n">metric_name</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">current_value</span><span class="sh">'</span><span class="p">:</span> <span class="n">current_value</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">baseline_value</span><span class="sh">'</span><span class="p">:</span> <span class="n">baseline_value</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">relative_change</span><span class="sh">'</span><span class="p">:</span> <span class="n">relative_change</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">severity</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">high</span><span class="sh">'</span> <span class="k">if</span> <span class="n">relative_change</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.1</span> <span class="k">else</span> <span class="sh">'</span><span class="s">medium</span><span class="sh">'</span>
                    <span class="p">})</span>
                
                <span class="c1"># Alert if false positive rate increases by more than 10%
</span>                <span class="k">elif</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="sh">'</span><span class="s">false_positive_rate</span><span class="sh">'</span> <span class="ow">and</span> <span class="n">relative_change</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="n">alerts</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">'</span><span class="s">metric</span><span class="sh">'</span><span class="p">:</span> <span class="n">metric_name</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">current_value</span><span class="sh">'</span><span class="p">:</span> <span class="n">current_value</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">baseline_value</span><span class="sh">'</span><span class="p">:</span> <span class="n">baseline_value</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">relative_change</span><span class="sh">'</span><span class="p">:</span> <span class="n">relative_change</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">severity</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">high</span><span class="sh">'</span> <span class="k">if</span> <span class="n">relative_change</span> <span class="o">&gt;</span> <span class="mf">0.2</span> <span class="k">else</span> <span class="sh">'</span><span class="s">medium</span><span class="sh">'</span>
                    <span class="p">})</span>
        
        <span class="c1"># Send alerts if necessary
</span>        <span class="k">if</span> <span class="n">alerts</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_send_alerts</span><span class="p">(</span><span class="n">alerts</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">current_metrics</span><span class="sh">'</span><span class="p">:</span> <span class="n">current_metrics</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">baseline_metrics</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">baseline_metrics</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">alerts</span><span class="sh">'</span><span class="p">:</span> <span class="n">alerts</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_send_alerts</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">alerts</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Send alerts to the team</span><span class="sh">"""</span>
        
        <span class="n">high_severity_alerts</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alerts</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="sh">'</span><span class="s">severity</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">high</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">medium_severity_alerts</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alerts</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="sh">'</span><span class="s">severity</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">medium</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">high_severity_alerts</span><span class="p">:</span>
            <span class="c1"># Send immediate notification (Slack, PagerDuty, etc.)
</span>            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">üö® HIGH SEVERITY: Model </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">model_name</span><span class="si">}</span><span class="s"> performance degradation detected:</span><span class="se">\n</span><span class="sh">"</span>
            <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="n">high_severity_alerts</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">‚Ä¢ </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="sh">'</span><span class="s">metric</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="sh">'</span><span class="s">current_value</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">(baseline: </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="sh">'</span><span class="s">baseline_value</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">, </span><span class="sh">"</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">change: </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="sh">'</span><span class="s">relative_change</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="o">%</span><span class="si">}</span><span class="s">)</span><span class="se">\n</span><span class="sh">"</span>
            
            <span class="nf">send_slack_alert</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="sh">"</span><span class="s">#ml-alerts</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">medium_severity_alerts</span><span class="p">:</span>
            <span class="c1"># Log for daily review
</span>            <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="n">medium_severity_alerts</span><span class="p">:</span>
                <span class="nf">log_performance_alert</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="chapter-8-the-feature-store-revelation">Chapter 8: The Feature Store Revelation</h2>

<p>As Sarah dug deeper into the performance discrepancy, she realized that the root issue wasn‚Äôt the model itself, but the feature pipeline. Different features were being computed slightly differently in training versus production, leading to subtle but important differences.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FeatureConsistencyValidator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">training_features</span><span class="p">,</span> <span class="n">production_features</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">training_features</span> <span class="o">=</span> <span class="n">training_features</span>
        <span class="n">self</span><span class="p">.</span><span class="n">production_features</span> <span class="o">=</span> <span class="n">production_features</span>
    
    <span class="k">def</span> <span class="nf">validate_feature_consistency</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Validate that features are computed consistently</span><span class="sh">"""</span>
        
        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Check feature names
</span>        <span class="n">training_cols</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">training_features</span><span class="p">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">production_cols</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">production_features</span><span class="p">.</span><span class="n">columns</span><span class="p">)</span>
        
        <span class="n">missing_in_production</span> <span class="o">=</span> <span class="n">training_cols</span> <span class="o">-</span> <span class="n">production_cols</span>
        <span class="n">extra_in_production</span> <span class="o">=</span> <span class="n">production_cols</span> <span class="o">-</span> <span class="n">training_cols</span>
        
        <span class="k">if</span> <span class="n">missing_in_production</span><span class="p">:</span>
            <span class="n">issues</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">missing_features</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">features</span><span class="sh">'</span><span class="p">:</span> <span class="nf">list</span><span class="p">(</span><span class="n">missing_in_production</span><span class="p">),</span>
                <span class="sh">'</span><span class="s">severity</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">high</span><span class="sh">'</span>
            <span class="p">})</span>
        
        <span class="k">if</span> <span class="n">extra_in_production</span><span class="p">:</span>
            <span class="n">issues</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">extra_features</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">features</span><span class="sh">'</span><span class="p">:</span> <span class="nf">list</span><span class="p">(</span><span class="n">extra_in_production</span><span class="p">),</span>
                <span class="sh">'</span><span class="s">severity</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">medium</span><span class="sh">'</span>
            <span class="p">})</span>
        
        <span class="c1"># Check feature distributions for common features
</span>        <span class="n">common_features</span> <span class="o">=</span> <span class="n">training_cols</span> <span class="o">&amp;</span> <span class="n">production_cols</span>
        
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">common_features</span><span class="p">:</span>
            <span class="n">training_stats</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get_feature_stats</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">training_features</span><span class="p">[</span><span class="n">feature</span><span class="p">])</span>
            <span class="n">production_stats</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get_feature_stats</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">production_features</span><span class="p">[</span><span class="n">feature</span><span class="p">])</span>
            
            <span class="c1"># Check for significant differences in basic statistics
</span>            <span class="k">if</span> <span class="nf">abs</span><span class="p">(</span><span class="n">training_stats</span><span class="p">[</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">]</span> <span class="o">-</span> <span class="n">production_stats</span><span class="p">[</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">training_stats</span><span class="p">[</span><span class="sh">'</span><span class="s">std</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">issues</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                    <span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">distribution_shift</span><span class="sh">'</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">feature</span><span class="sh">'</span><span class="p">:</span> <span class="n">feature</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">training_mean</span><span class="sh">'</span><span class="p">:</span> <span class="n">training_stats</span><span class="p">[</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">],</span>
                    <span class="sh">'</span><span class="s">production_mean</span><span class="sh">'</span><span class="p">:</span> <span class="n">production_stats</span><span class="p">[</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">],</span>
                    <span class="sh">'</span><span class="s">severity</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">high</span><span class="sh">'</span>
                <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">issues</span>
    
    <span class="k">def</span> <span class="nf">_get_feature_stats</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">feature_series</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get basic statistics for a feature</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">:</span> <span class="n">feature_series</span><span class="p">.</span><span class="nf">mean</span><span class="p">(),</span>
            <span class="sh">'</span><span class="s">std</span><span class="sh">'</span><span class="p">:</span> <span class="n">feature_series</span><span class="p">.</span><span class="nf">std</span><span class="p">(),</span>
            <span class="sh">'</span><span class="s">min</span><span class="sh">'</span><span class="p">:</span> <span class="n">feature_series</span><span class="p">.</span><span class="nf">min</span><span class="p">(),</span>
            <span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">:</span> <span class="n">feature_series</span><span class="p">.</span><span class="nf">max</span><span class="p">(),</span>
            <span class="sh">'</span><span class="s">null_count</span><span class="sh">'</span><span class="p">:</span> <span class="n">feature_series</span><span class="p">.</span><span class="nf">isnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">(),</span>
            <span class="sh">'</span><span class="s">unique_count</span><span class="sh">'</span><span class="p">:</span> <span class="n">feature_series</span><span class="p">.</span><span class="nf">nunique</span><span class="p">()</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>This led Sarah to implement a proper feature store:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FeatureStore</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="n">self</span><span class="p">.</span><span class="n">feature_definitions</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_load_feature_definitions</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="nc">RedisCache</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">redis_url</span><span class="sh">'</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">register_feature</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">computation_func</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Register a feature with its computation logic</span><span class="sh">"""</span>
        
        <span class="n">feature_def</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">computation_func</span><span class="sh">'</span><span class="p">:</span> <span class="n">computation_func</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">dependencies</span><span class="sh">'</span><span class="p">:</span> <span class="n">dependencies</span> <span class="ow">or</span> <span class="p">[],</span>
            <span class="sh">'</span><span class="s">ttl</span><span class="sh">'</span><span class="p">:</span> <span class="n">ttl</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">version</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get_next_version</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
            <span class="sh">'</span><span class="s">created_at</span><span class="sh">'</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        <span class="p">}</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">feature_definitions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_def</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">_save_feature_definitions</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">feature_def</span>
    
    <span class="k">def</span> <span class="nf">get_features</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Get features for an entity</span><span class="sh">"""</span>
        
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span> <span class="ow">or</span> <span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">feature_name</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">:</span>
            <span class="c1"># Check cache first
</span>            <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">feature_name</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">entity_id</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">timestamp</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="sh">'</span><span class="s">%Y%m%d%H</span><span class="sh">'</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
            <span class="n">cached_value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">cached_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">features</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cached_value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Compute feature
</span>                <span class="n">feature_def</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">feature_definitions</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span>
                <span class="n">feature_value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_compute_feature</span><span class="p">(</span><span class="n">feature_def</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
                
                <span class="c1"># Cache the result
</span>                <span class="n">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">feature_value</span><span class="p">,</span> <span class="n">ex</span><span class="o">=</span><span class="n">feature_def</span><span class="p">[</span><span class="sh">'</span><span class="s">ttl</span><span class="sh">'</span><span class="p">])</span>
                <span class="n">features</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_value</span>
        
        <span class="k">return</span> <span class="n">features</span>
    
    <span class="k">def</span> <span class="nf">_compute_feature</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">feature_def</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Compute a feature value</span><span class="sh">"""</span>
        
        <span class="n">computation_func</span> <span class="o">=</span> <span class="n">feature_def</span><span class="p">[</span><span class="sh">'</span><span class="s">computation_func</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="c1"># Handle dependencies
</span>        <span class="n">dependency_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">dep_name</span> <span class="ow">in</span> <span class="n">feature_def</span><span class="p">[</span><span class="sh">'</span><span class="s">dependencies</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">dep_def</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">feature_definitions</span><span class="p">[</span><span class="n">dep_name</span><span class="p">]</span>
            <span class="n">dependency_values</span><span class="p">[</span><span class="n">dep_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_compute_feature</span><span class="p">(</span><span class="n">dep_def</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
        
        <span class="c1"># Compute the feature
</span>        <span class="k">return</span> <span class="nf">computation_func</span><span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="o">**</span><span class="n">dependency_values</span><span class="p">)</span>

<span class="c1"># Example feature registrations
</span><span class="n">feature_store</span> <span class="o">=</span> <span class="nc">FeatureStore</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">compute_transaction_velocity</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="nf">calculate_transaction_velocity</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">window_hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">compute_merchant_risk</span><span class="p">(</span><span class="n">merchant_id</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="nf">calculate_merchant_risk_score</span><span class="p">(</span><span class="n">merchant_id</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">compute_user_merchant_interaction</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">merchant_risk</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Feature that depends on another feature</span><span class="sh">"""</span>
    
    <span class="c1"># Get user's historical interactions with this merchant category
</span>    <span class="n">user_history</span> <span class="o">=</span> <span class="nf">get_user_merchant_history</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
    
    <span class="c1"># Combine with merchant risk
</span>    <span class="k">if</span> <span class="n">merchant_risk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">interaction_score</span> <span class="o">=</span> <span class="n">user_history</span><span class="p">[</span><span class="sh">'</span><span class="s">interaction_count</span><span class="sh">'</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">merchant_risk</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">interaction_score</span> <span class="o">=</span> <span class="n">user_history</span><span class="p">[</span><span class="sh">'</span><span class="s">interaction_count</span><span class="sh">'</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">interaction_score</span>

<span class="c1"># Register features
</span><span class="n">feature_store</span><span class="p">.</span><span class="nf">register_feature</span><span class="p">(</span>
    <span class="sh">'</span><span class="s">transaction_velocity_24h</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">compute_transaction_velocity</span><span class="p">,</span>
    <span class="n">ttl</span><span class="o">=</span><span class="mi">3600</span>  <span class="c1"># 1 hour cache
</span><span class="p">)</span>

<span class="n">feature_store</span><span class="p">.</span><span class="nf">register_feature</span><span class="p">(</span>
    <span class="sh">'</span><span class="s">merchant_risk_score</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">compute_merchant_risk</span><span class="p">,</span>
    <span class="n">ttl</span><span class="o">=</span><span class="mi">86400</span>  <span class="c1"># 24 hour cache
</span><span class="p">)</span>

<span class="n">feature_store</span><span class="p">.</span><span class="nf">register_feature</span><span class="p">(</span>
    <span class="sh">'</span><span class="s">user_merchant_interaction</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">compute_user_merchant_interaction</span><span class="p">,</span>
    <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">merchant_risk_score</span><span class="sh">'</span><span class="p">],</span>
    <span class="n">ttl</span><span class="o">=</span><span class="mi">3600</span>
<span class="p">)</span>
</code></pre></div></div>

<hr />

<h2 id="chapter-9-the-business-value-question">Chapter 9: The Business Value Question</h2>

<p>Six months into the MLflow implementation, Sarah found herself in an uncomfortable position. The technical implementation was a success - models were properly versioned, deployments were automated, and monitoring was comprehensive. But during a quarterly business review, the CFO asked a simple question that shook her: ‚ÄúHow much money are we actually saving with this new ML system?‚Äù</p>

<p>The fraud prevention team had always measured success in terms of fraud detected and false positives minimized. But when the finance team analyzed the total cost of ownership, including development time, infrastructure costs, and operational overhead, the picture became murky.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calculate_ml_system_roi</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">Calculate the ROI of the ML fraud detection system</span><span class="sh">"""</span>
    
    <span class="c1"># Costs
</span>    <span class="n">infrastructure_costs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">mlflow_server</span><span class="sh">'</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span>  <span class="c1"># Monthly cost
</span>        <span class="sh">'</span><span class="s">feature_store</span><span class="sh">'</span><span class="p">:</span> <span class="mi">3000</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">model_serving</span><span class="sh">'</span><span class="p">:</span> <span class="mi">1500</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">monitoring</span><span class="sh">'</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">data_storage</span><span class="sh">'</span><span class="p">:</span> <span class="mi">1200</span>
    <span class="p">}</span>
    
    <span class="n">personnel_costs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">ml_engineers</span><span class="sh">'</span><span class="p">:</span> <span class="mi">15000</span><span class="p">,</span>  <span class="c1"># Monthly fully loaded cost for team
</span>        <span class="sh">'</span><span class="s">data_engineers</span><span class="sh">'</span><span class="p">:</span> <span class="mi">8000</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">devops</span><span class="sh">'</span><span class="p">:</span> <span class="mi">4000</span>
    <span class="p">}</span>
    
    <span class="n">monthly_costs</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">infrastructure_costs</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span> <span class="o">+</span> <span class="nf">sum</span><span class="p">(</span><span class="n">personnel_costs</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span>
    <span class="n">annual_costs</span> <span class="o">=</span> <span class="n">monthly_costs</span> <span class="o">*</span> <span class="mi">12</span>
    
    <span class="c1"># Benefits (this is where it gets complicated)
</span>    
    <span class="c1"># Direct fraud prevention
</span>    <span class="n">estimated_fraud_prevented</span> <span class="o">=</span> <span class="mi">2_500_000</span>  <span class="c1"># Annual estimate
</span>    
    <span class="c1"># But what would rule-based system have caught?
</span>    <span class="n">rule_based_effectiveness</span> <span class="o">=</span> <span class="mf">0.70</span>  <span class="c1"># Estimated
</span>    <span class="n">ml_effectiveness</span> <span class="o">=</span> <span class="mf">0.85</span>  <span class="c1"># Measured
</span>    
    <span class="n">incremental_fraud_prevented</span> <span class="o">=</span> <span class="n">estimated_fraud_prevented</span> <span class="o">*</span> <span class="p">(</span><span class="n">ml_effectiveness</span> <span class="o">-</span> <span class="n">rule_based_effectiveness</span><span class="p">)</span>
    
    <span class="c1"># Cost of false positives
</span>    <span class="n">avg_legitimate_transaction</span> <span class="o">=</span> <span class="mi">150</span>
    <span class="n">false_positive_rate</span> <span class="o">=</span> <span class="mf">0.02</span>
    <span class="n">daily_transactions</span> <span class="o">=</span> <span class="mi">10000</span>
    
    <span class="n">annual_false_positives</span> <span class="o">=</span> <span class="n">daily_transactions</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">*</span> <span class="n">false_positive_rate</span>
    <span class="n">false_positive_cost</span> <span class="o">=</span> <span class="n">annual_false_positives</span> <span class="o">*</span> <span class="n">avg_legitimate_transaction</span> <span class="o">*</span> <span class="mf">0.05</span>  <span class="c1"># Assume 5% abandon rate
</span>    
    <span class="c1"># Customer experience impact (hard to quantify)
</span>    <span class="n">customer_satisfaction_impact</span> <span class="o">=</span> <span class="o">-</span><span class="mi">50_000</span>  <span class="c1"># Estimated annual cost
</span>    
    <span class="n">net_annual_benefit</span> <span class="o">=</span> <span class="n">incremental_fraud_prevented</span> <span class="o">-</span> <span class="n">false_positive_cost</span> <span class="o">+</span> <span class="n">customer_satisfaction_impact</span>
    <span class="n">roi</span> <span class="o">=</span> <span class="p">(</span><span class="n">net_annual_benefit</span> <span class="o">-</span> <span class="n">annual_costs</span><span class="p">)</span> <span class="o">/</span> <span class="n">annual_costs</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">annual_costs</span><span class="sh">'</span><span class="p">:</span> <span class="n">annual_costs</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">incremental_fraud_prevented</span><span class="sh">'</span><span class="p">:</span> <span class="n">incremental_fraud_prevented</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">false_positive_cost</span><span class="sh">'</span><span class="p">:</span> <span class="n">false_positive_cost</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">net_annual_benefit</span><span class="sh">'</span><span class="p">:</span> <span class="n">net_annual_benefit</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">roi</span><span class="sh">'</span><span class="p">:</span> <span class="n">roi</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">break_even_fraud_amount</span><span class="sh">'</span><span class="p">:</span> <span class="n">annual_costs</span> <span class="o">+</span> <span class="n">false_positive_cost</span> <span class="o">-</span> <span class="n">customer_satisfaction_impact</span>
    <span class="p">}</span>

<span class="c1"># The uncomfortable truth
</span><span class="n">roi_analysis</span> <span class="o">=</span> <span class="nf">calculate_ml_system_roi</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Annual ROI: </span><span class="si">{</span><span class="n">roi_analysis</span><span class="p">[</span><span class="sh">'</span><span class="s">roi</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="o">%</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Break-even fraud prevention needed: $</span><span class="si">{</span><span class="n">roi_analysis</span><span class="p">[</span><span class="sh">'</span><span class="s">break_even_fraud_amount</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">,.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="the-complexity-of-measuring-ml-value">The Complexity of Measuring ML Value</h3>

<p>Sarah realized that measuring the value of ML systems was much more complex than traditional software projects:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MLValueMeasurement</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">baseline_period</span> <span class="o">=</span> <span class="sh">"</span><span class="s">2023-Q1</span><span class="sh">"</span>  <span class="c1"># Before ML implementation
</span>        <span class="n">self</span><span class="p">.</span><span class="n">ml_period</span> <span class="o">=</span> <span class="sh">"</span><span class="s">2023-Q4</span><span class="sh">"</span>        <span class="c1"># After ML implementation
</span>    
    <span class="k">def</span> <span class="nf">measure_direct_impact</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Measure direct, quantifiable impacts</span><span class="sh">"""</span>
        
        <span class="n">baseline_metrics</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get_baseline_metrics</span><span class="p">()</span>
        <span class="n">current_metrics</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get_current_metrics</span><span class="p">()</span>
        
        <span class="n">direct_impacts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">fraud_detection_improvement</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">baseline_fraud_caught</span><span class="sh">'</span><span class="p">:</span> <span class="n">baseline_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">fraud_caught</span><span class="sh">'</span><span class="p">],</span>
                <span class="sh">'</span><span class="s">current_fraud_caught</span><span class="sh">'</span><span class="p">:</span> <span class="n">current_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">fraud_caught</span><span class="sh">'</span><span class="p">],</span>
                <span class="sh">'</span><span class="s">improvement</span><span class="sh">'</span><span class="p">:</span> <span class="n">current_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">fraud_caught</span><span class="sh">'</span><span class="p">]</span> <span class="o">-</span> <span class="n">baseline_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">fraud_caught</span><span class="sh">'</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="sh">'</span><span class="s">false_positive_reduction</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">baseline_fp_rate</span><span class="sh">'</span><span class="p">:</span> <span class="n">baseline_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">false_positive_rate</span><span class="sh">'</span><span class="p">],</span>
                <span class="sh">'</span><span class="s">current_fp_rate</span><span class="sh">'</span><span class="p">:</span> <span class="n">current_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">false_positive_rate</span><span class="sh">'</span><span class="p">],</span>
                <span class="sh">'</span><span class="s">improvement</span><span class="sh">'</span><span class="p">:</span> <span class="n">baseline_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">false_positive_rate</span><span class="sh">'</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">false_positive_rate</span><span class="sh">'</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="sh">'</span><span class="s">processing_time</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">baseline_avg_time</span><span class="sh">'</span><span class="p">:</span> <span class="n">baseline_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">avg_processing_time</span><span class="sh">'</span><span class="p">],</span>
                <span class="sh">'</span><span class="s">current_avg_time</span><span class="sh">'</span><span class="p">:</span> <span class="n">current_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">avg_processing_time</span><span class="sh">'</span><span class="p">],</span>
                <span class="sh">'</span><span class="s">improvement</span><span class="sh">'</span><span class="p">:</span> <span class="n">baseline_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">avg_processing_time</span><span class="sh">'</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">avg_processing_time</span><span class="sh">'</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">direct_impacts</span>
    
    <span class="k">def</span> <span class="nf">measure_indirect_impact</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Measure indirect, harder-to-quantify impacts</span><span class="sh">"""</span>
        
        <span class="c1"># These are estimates based on surveys, customer feedback, etc.
</span>        <span class="n">indirect_impacts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">customer_satisfaction</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">description</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Reduced friction in legitimate transactions</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">estimated_value</span><span class="sh">'</span><span class="p">:</span> <span class="mi">75_000</span><span class="p">,</span>  <span class="c1"># Annual estimate
</span>                <span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">medium</span><span class="sh">'</span>
            <span class="p">},</span>
            <span class="sh">'</span><span class="s">operational_efficiency</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">description</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Reduced manual review workload</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">estimated_value</span><span class="sh">'</span><span class="p">:</span> <span class="mi">120_000</span><span class="p">,</span>  <span class="c1"># Annual estimate
</span>                <span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">high</span><span class="sh">'</span>
            <span class="p">},</span>
            <span class="sh">'</span><span class="s">regulatory_compliance</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">description</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Better audit trails and explainability</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">estimated_value</span><span class="sh">'</span><span class="p">:</span> <span class="mi">50_000</span><span class="p">,</span>  <span class="c1"># Annual estimate
</span>                <span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">low</span><span class="sh">'</span>
            <span class="p">},</span>
            <span class="sh">'</span><span class="s">competitive_advantage</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">description</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Faster adaptation to new fraud patterns</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">estimated_value</span><span class="sh">'</span><span class="p">:</span> <span class="mi">200_000</span><span class="p">,</span>  <span class="c1"># Annual estimate
</span>                <span class="sh">'</span><span class="s">confidence</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">low</span><span class="sh">'</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">indirect_impacts</span>
    
    <span class="k">def</span> <span class="nf">measure_opportunity_cost</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">What else could the team have built with this effort?</span><span class="sh">"""</span>
        
        <span class="c1"># Total effort spent on ML system
</span>        <span class="n">total_engineering_months</span> <span class="o">=</span> <span class="mi">18</span>  <span class="c1"># Across the team
</span>        <span class="n">average_monthly_cost</span> <span class="o">=</span> <span class="mi">12_000</span>  <span class="c1"># Fully loaded cost per engineer
</span>        
        <span class="n">total_investment</span> <span class="o">=</span> <span class="n">total_engineering_months</span> <span class="o">*</span> <span class="n">average_monthly_cost</span>
        
        <span class="c1"># Alternative projects that were delayed/not pursued
</span>        <span class="n">opportunity_costs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">payment_optimization</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">description</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Optimizing payment routing for cost reduction</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">estimated_annual_value</span><span class="sh">'</span><span class="p">:</span> <span class="mi">300_000</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">probability_of_success</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.8</span>
            <span class="p">},</span>
            <span class="sh">'</span><span class="s">customer_onboarding</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">description</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Streamlining customer onboarding process</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">estimated_annual_value</span><span class="sh">'</span><span class="p">:</span> <span class="mi">150_000</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">probability_of_success</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.9</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="n">expected_opportunity_cost</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span>
            <span class="n">proj</span><span class="p">[</span><span class="sh">'</span><span class="s">estimated_annual_value</span><span class="sh">'</span><span class="p">]</span> <span class="o">*</span> <span class="n">proj</span><span class="p">[</span><span class="sh">'</span><span class="s">probability_of_success</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">proj</span> <span class="ow">in</span> <span class="n">opportunity_costs</span><span class="p">.</span><span class="nf">values</span><span class="p">()</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">total_investment</span><span class="sh">'</span><span class="p">:</span> <span class="n">total_investment</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">opportunity_costs</span><span class="sh">'</span><span class="p">:</span> <span class="n">opportunity_costs</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">expected_opportunity_cost</span><span class="sh">'</span><span class="p">:</span> <span class="n">expected_opportunity_cost</span>
        <span class="p">}</span>
</code></pre></div></div>

<h3 id="the-attribution-problem">The Attribution Problem</h3>

<p>One of the biggest challenges Sarah faced was attribution. During the same period that they implemented the ML system, the company also:</p>

<ul>
  <li>Updated their transaction processing infrastructure</li>
  <li>Implemented new security measures</li>
  <li>Changed their customer onboarding process</li>
  <li>Updated their mobile app</li>
</ul>

<p>How much of the improvement in fraud detection was due to the ML model versus these other changes?</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">analyze_attribution_problem</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">Attempt to disentangle the impact of different initiatives</span><span class="sh">"""</span>
    
    <span class="c1"># Timeline of changes
</span>    <span class="n">initiatives</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">ml_fraud_detection</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">start_date</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">2023-03-01</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">full_deployment</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">2023-06-01</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">expected_impact</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">fraud_detection_rate</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">false_positive_rate</span><span class="sh">'</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="sh">'</span><span class="s">infrastructure_upgrade</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">start_date</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">2023-02-15</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">full_deployment</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">2023-04-01</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">expected_impact</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">processing_speed</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">system_reliability</span><span class="sh">'</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="sh">'</span><span class="s">security_measures</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">start_date</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">2023-04-01</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">full_deployment</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">2023-05-01</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">expected_impact</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">fraud_detection_rate</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">account_takeover_rate</span><span class="sh">'</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="sh">'</span><span class="s">onboarding_changes</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">start_date</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">2023-05-15</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">full_deployment</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">2023-07-01</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">expected_impact</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">customer_satisfaction</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">onboarding_time</span><span class="sh">'</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1"># Try to isolate impact using different approaches
</span>    
    <span class="c1"># Approach 1: Time series analysis with changepoint detection
</span>    <span class="kn">from</span> <span class="n">ruptures</span> <span class="kn">import</span> <span class="n">Pelt</span><span class="p">,</span> <span class="n">rpt</span>
    
    <span class="c1"># Get daily fraud detection rates
</span>    <span class="n">daily_metrics</span> <span class="o">=</span> <span class="nf">get_daily_metrics</span><span class="p">(</span><span class="sh">'</span><span class="s">2023-01-01</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">2023-12-31</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">fraud_detection_rate</span> <span class="o">=</span> <span class="n">daily_metrics</span><span class="p">[</span><span class="sh">'</span><span class="s">fraud_detection_rate</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span>
    
    <span class="c1"># Detect changepoints
</span>    <span class="n">model</span> <span class="o">=</span> <span class="sh">"</span><span class="s">rbf</span><span class="sh">"</span>
    <span class="n">algo</span> <span class="o">=</span> <span class="nc">Pelt</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">).</span><span class="nf">fit</span><span class="p">(</span><span class="n">fraud_detection_rate</span><span class="p">)</span>
    <span class="n">changepoints</span> <span class="o">=</span> <span class="n">algo</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">pen</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    
    <span class="c1"># Approach 2: Regression with intervention indicators
</span>    <span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
    <span class="kn">from</span> <span class="n">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">daily_metrics</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
    
    <span class="c1"># Create intervention indicators
</span>    <span class="k">for</span> <span class="n">initiative</span><span class="p">,</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">initiatives</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="sh">'</span><span class="s">start_date</span><span class="sh">'</span><span class="p">])</span>
        <span class="n">full_date</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="sh">'</span><span class="s">full_deployment</span><span class="sh">'</span><span class="p">])</span>
        
        <span class="c1"># Gradual rollout indicator
</span>        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">initiative</span><span class="si">}</span><span class="s">_rollout</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start_date</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">initiative</span><span class="si">}</span><span class="s">_rollout</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">start_date</span><span class="p">).</span><span class="n">days</span> <span class="o">/</span> <span class="p">(</span><span class="n">full_date</span> <span class="o">-</span> <span class="n">start_date</span><span class="p">).</span><span class="n">days</span>
        <span class="p">).</span><span class="nf">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Full deployment indicator
</span>        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">initiative</span><span class="si">}</span><span class="s">_full</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">full_date</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="c1"># Regression to estimate individual impacts
</span>    <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">columns</span> <span class="k">if</span> <span class="sh">'</span><span class="s">_rollout</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">or</span> <span class="sh">'</span><span class="s">_full</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">fraud_detection_rate</span><span class="sh">'</span><span class="p">]</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="nc">LinearRegression</span><span class="p">().</span><span class="nf">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    
    <span class="c1"># Attribution estimates
</span>    <span class="n">attribution_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">):</span>
        <span class="n">attribution_results</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">coefficient</span><span class="sh">'</span><span class="p">:</span> <span class="n">model</span><span class="p">.</span><span class="n">coef_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="sh">'</span><span class="s">estimated_impact</span><span class="sh">'</span><span class="p">:</span> <span class="n">model</span><span class="p">.</span><span class="n">coef_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="n">feature</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">changepoints</span><span class="sh">'</span><span class="p">:</span> <span class="n">changepoints</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">attribution_estimates</span><span class="sh">'</span><span class="p">:</span> <span class="n">attribution_results</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">r_squared</span><span class="sh">'</span><span class="p">:</span> <span class="n">model</span><span class="p">.</span><span class="nf">score</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="chapter-10-the-uncomfortable-conclusion">Chapter 10: The Uncomfortable Conclusion</h2>

<p>As Sarah prepared her annual review of the MLflow implementation, she faced some uncomfortable truths. The project had been a technical success but the business impact was ambiguous at best.</p>

<h3 id="what-worked-well">What Worked Well</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">summarize_technical_success</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">model_versioning</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">before</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Ad-hoc git tags and file naming</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">after</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Structured versioning with metadata</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">improvement</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Significant</span><span class="sh">'</span>
        <span class="p">},</span>
        <span class="sh">'</span><span class="s">experiment_tracking</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">before</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Spreadsheets and manual logging</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">after</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Automated tracking with MLflow</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">improvement</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Transformational</span><span class="sh">'</span>
        <span class="p">},</span>
        <span class="sh">'</span><span class="s">deployment_process</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">before</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Manual builds and deployments</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">after</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Automated pipeline from registry</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">improvement</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Significant</span><span class="sh">'</span>
        <span class="p">},</span>
        <span class="sh">'</span><span class="s">monitoring</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">before</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Basic application logs</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">after</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Comprehensive ML-specific monitoring</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">improvement</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Significant</span><span class="sh">'</span>
        <span class="p">},</span>
        <span class="sh">'</span><span class="s">reproducibility</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">before</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Difficult to reproduce results</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">after</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Complete environment and data tracking</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">improvement</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Transformational</span><span class="sh">'</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<h3 id="what-didnt-work-as-expected">What Didn‚Äôt Work As Expected</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">summarize_challenges</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">business_value_measurement</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Difficult to isolate ML impact from other initiatives</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">impact</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">High</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">resolution</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Ongoing</span><span class="sh">'</span>
        <span class="p">},</span>
        <span class="sh">'</span><span class="s">feature_engineering_complexity</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Feature pipelines more complex than anticipated</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">impact</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Medium</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">resolution</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Partially addressed with feature store</span><span class="sh">'</span>
        <span class="p">},</span>
        <span class="sh">'</span><span class="s">delayed_feedback_loops</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Fraud confirmation takes days/weeks</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">impact</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">High</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">resolution</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Accepted as domain constraint</span><span class="sh">'</span>
        <span class="p">},</span>
        <span class="sh">'</span><span class="s">model_performance_vs_business_metrics</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Better ML metrics not always better business outcomes</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">impact</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">High</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">resolution</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Ongoing research</span><span class="sh">'</span>
        <span class="p">},</span>
        <span class="sh">'</span><span class="s">organizational_change_management</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Team adoption slower than expected</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">impact</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Medium</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">resolution</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Training and process changes</span><span class="sh">'</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<h3 id="lessons-learned">Lessons Learned</h3>

<p>Sarah‚Äôs final reflection centered on several key insights:</p>

<ol>
  <li>
    <p><strong>Technical Excellence ‚â† Business Value</strong>: Perfect MLOps infrastructure doesn‚Äôt automatically translate to business success.</p>
  </li>
  <li>
    <p><strong>Context Matters More Than Tools</strong>: The specific domain (fraud detection with delayed feedback) created unique challenges that no tool could solve.</p>
  </li>
  <li>
    <p><strong>Measurement is Hard</strong>: Attributing business outcomes to ML interventions is much more complex than measuring model performance.</p>
  </li>
  <li>
    <p><strong>People and Process Trump Technology</strong>: The biggest challenges were organizational, not technical.</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">final_recommendations</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">for_future_ml_projects</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span>
            <span class="sh">'</span><span class="s">Define business success metrics upfront, not just ML metrics</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">Plan for attribution analysis from day one</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">Invest heavily in change management and training</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">Start with simpler use cases to build confidence</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">Establish baseline measurements before any changes</span><span class="sh">'</span>
        <span class="p">],</span>
        <span class="sh">'</span><span class="s">for_mlops_tools</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span>
            <span class="sh">'</span><span class="s">MLflow is excellent for experiment tracking and model versioning</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">Feature stores are essential for complex feature pipelines</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">Monitoring should focus on business metrics, not just model metrics</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">A/B testing infrastructure is crucial but complex to implement well</span><span class="sh">'</span>
        <span class="p">],</span>
        <span class="sh">'</span><span class="s">for_teams_considering_ml</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span>
            <span class="sh">'</span><span class="s">Honestly assess whether ML is the right solution</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">Consider the total cost of ownership, including maintenance</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">Plan for the long-term evolution of the system</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">Invest in data quality and feature engineering expertise</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">Be prepared for ambiguous results and complex attribution</span><span class="sh">'</span>
        <span class="p">]</span>
    <span class="p">}</span>
</code></pre></div></div>

<h3 id="the-question-that-remained">The Question That Remained</h3>

<p>At the end of her analysis, Sarah was left with the question that had started to keep her awake at night: ‚ÄúIn a world where simple rules could catch 70% of fraud, was building a complex ML system that catches 85% actually worth the investment?‚Äù</p>

<p>The answer, she realized, wasn‚Äôt just technical or even financial. It was philosophical, strategic, and deeply context-dependent. Some organizations might benefit enormously from that extra 15% detection rate. Others might be better served by investing in customer experience improvements or operational efficiency.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">the_ultimate_question</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">
    The question every ML team should ask themselves:
    Are we solving the right problem?
    </span><span class="sh">"""</span>
    
    <span class="n">considerations</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">problem_complexity</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Could this be solved more simply?</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">marginal_improvement</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Is the incremental improvement worth the cost?</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">opportunity_cost</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">What else could we build with this effort?</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">maintainability</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Can we sustain this long-term?</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">organizational_fit</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Do we have the right culture and processes?</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">external_factors</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">How much of our success depends on factors we cannot control?</span><span class="sh">'</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">considerations</span>
</code></pre></div></div>

<hr />

<h2 id="epilogue-six-months-later">Epilogue: Six Months Later</h2>

<p>Six months after Sarah‚Äôs annual review, the company made a surprising decision. They decided to simplify the fraud detection system, removing some of the ML complexity and focusing on a hybrid approach that used simpler models for 90% of transactions and reserved the complex ML models for edge cases.</p>

<p>The result? Customer satisfaction improved, operational costs decreased, and fraud detection rates remained essentially unchanged. The MLflow infrastructure remained, but was repurposed for other ML initiatives where the value proposition was clearer.</p>

<p>Sarah moved on to a new role at a healthcare technology company, where she‚Äôs applying the lessons learned to a different domain. Her experience with the fraud detection system taught her that the most important skill for an ML engineer isn‚Äôt knowing the latest algorithms or tools - it‚Äôs knowing when not to use them.</p>

<h3 id="final-code-the-decision-framework">Final Code: The Decision Framework</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MLProjectDecisionFramework</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">
    A framework for deciding whether to pursue an ML solution
    </span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sh">'</span><span class="s">problem_complexity</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">data_availability</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">feedback_loop_speed</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">business_impact_measurement</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">organizational_readiness</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">alternative_solutions</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">maintenance_capabilities</span><span class="sh">'</span>
        <span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">evaluate_project</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">project_details</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Evaluate whether an ML project is worth pursuing</span><span class="sh">"""</span>
        
        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Problem Complexity (0-10, higher = more complex, more suitable for ML)
</span>        <span class="n">scores</span><span class="p">[</span><span class="sh">'</span><span class="s">problem_complexity</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_assess_complexity</span><span class="p">(</span><span class="n">project_details</span><span class="p">)</span>
        
        <span class="c1"># Data Availability (0-10, higher = better data)
</span>        <span class="n">scores</span><span class="p">[</span><span class="sh">'</span><span class="s">data_availability</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_assess_data</span><span class="p">(</span><span class="n">project_details</span><span class="p">)</span>
        
        <span class="c1"># Feedback Loop Speed (0-10, higher = faster feedback)
</span>        <span class="n">scores</span><span class="p">[</span><span class="sh">'</span><span class="s">feedback_loop_speed</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_assess_feedback_speed</span><span class="p">(</span><span class="n">project_details</span><span class="p">)</span>
        
        <span class="c1"># Business Impact Measurement (0-10, higher = easier to measure)
</span>        <span class="n">scores</span><span class="p">[</span><span class="sh">'</span><span class="s">business_impact_measurement</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_assess_measurability</span><span class="p">(</span><span class="n">project_details</span><span class="p">)</span>
        
        <span class="c1"># Organizational Readiness (0-10, higher = more ready)
</span>        <span class="n">scores</span><span class="p">[</span><span class="sh">'</span><span class="s">organizational_readiness</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_assess_org_readiness</span><span class="p">(</span><span class="n">project_details</span><span class="p">)</span>
        
        <span class="c1"># Alternative Solutions (0-10, higher = ML significantly better than alternatives)
</span>        <span class="n">scores</span><span class="p">[</span><span class="sh">'</span><span class="s">alternative_solutions</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_assess_alternatives</span><span class="p">(</span><span class="n">project_details</span><span class="p">)</span>
        
        <span class="c1"># Maintenance Capabilities (0-10, higher = better equipped to maintain)
</span>        <span class="n">scores</span><span class="p">[</span><span class="sh">'</span><span class="s">maintenance_capabilities</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_assess_maintenance</span><span class="p">(</span><span class="n">project_details</span><span class="p">)</span>
        
        <span class="c1"># Calculate overall score and recommendation
</span>        <span class="n">overall_score</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">scores</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">overall_score</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">recommendation</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Strong candidate for ML</span><span class="sh">"</span>
        <span class="k">elif</span> <span class="n">overall_score</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">recommendation</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Proceed with caution</span><span class="sh">"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">recommendation</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Consider alternatives to ML</span><span class="sh">"</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">scores</span><span class="sh">'</span><span class="p">:</span> <span class="n">scores</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">overall_score</span><span class="sh">'</span><span class="p">:</span> <span class="n">overall_score</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">recommendation</span><span class="sh">'</span><span class="p">:</span> <span class="n">recommendation</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">next_steps</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">_generate_next_steps</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">overall_score</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_assess_complexity</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">project_details</span><span class="p">):</span>
        <span class="c1"># Implementation details would go here
</span>        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">_generate_next_steps</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">overall_score</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Generate specific next steps based on the assessment</span><span class="sh">"""</span>
        
        <span class="n">next_steps</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">scores</span><span class="p">[</span><span class="sh">'</span><span class="s">data_availability</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">next_steps</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">Invest in data collection and quality improvement</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">scores</span><span class="p">[</span><span class="sh">'</span><span class="s">feedback_loop_speed</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">next_steps</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">Establish faster feedback mechanisms or consider offline evaluation</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">scores</span><span class="p">[</span><span class="sh">'</span><span class="s">business_impact_measurement</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">next_steps</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">Define clear business metrics and measurement strategy</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">scores</span><span class="p">[</span><span class="sh">'</span><span class="s">organizational_readiness</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">next_steps</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">Invest in team training and process development</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">overall_score</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">next_steps</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">Explore rule-based or simpler statistical approaches first</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">next_steps</span>

<span class="c1"># The framework that Sarah wishes she had at the beginning
</span><span class="n">framework</span> <span class="o">=</span> <span class="nc">MLProjectDecisionFramework</span><span class="p">()</span>
</code></pre></div></div>

<p>This story serves as both a technical guide to implementing MLflow in a production environment and a cautionary tale about the complexities of delivering real business value through machine learning. The tools and techniques are important, but the questions we ask and the problems we choose to solve matter even more.</p>

<hr />

<p><em>End of Story</em></p>

<p><strong>About This Narrative</strong>: This story is based on real experiences implementing MLOps systems in production environments. While the characters and specific company details are fictional, the technical challenges, organizational issues, and philosophical questions are drawn from actual project experiences. The code examples are simplified for illustrative purposes but represent patterns used in real systems.</p>

<p><strong>Technical Resources</strong>:</p>
<ul>
  <li>All code examples are available in the accompanying repository</li>
  <li>Links to relevant MLflow documentation and best practices</li>
  <li>Additional resources for feature stores, monitoring, and A/B testing frameworks</li>
</ul>

<p><strong>Discussion Questions</strong>:</p>
<ol>
  <li>How do you measure the success of an ML project beyond model metrics?</li>
  <li>When is ML the wrong solution to a business problem?</li>
  <li>How do you handle the attribution problem in complex technical environments?</li>
  <li>What organizational changes are necessary to support ML in production?</li>
  <li>How do you balance technical excellence with business pragmatism?</li>
</ol>
</div><div class="footer-wrapper">
  <div class="footer-container">
    <footer translate="no">
      <div class="footer-text footer-text-centered long-copyright">
          <p>&copy;  Jeffrey Taylor. </p><a href="https://creativecommons.org/licenses/by-sa/4.0/deed.en" target="_blank" rel="noopener noreferrer" data-toggle="tooltip" data-placement="top" data-tooltip-no-hide title="Except where otherwise noted, content on this web site is licensed under a Creative Commons Attribution-ShareAlike 4.0 International License.">
              <img src="/assets/img/default/cc/cc.svg" alt="cc" width="12" height="12">&nbsp;<img src="/assets/img/default/cc/by.svg" alt="by" width="12" height="12">&nbsp;<img src="/assets/img/default/cc/sa.svg" alt="sa" width="12" height="12">&nbsp;<p>Some rights reserved.</p>
            </a></div>
      <p class="footer-powered"><span>Pwrd by </span><a href="https://github.com/MrGreensWorkshop/MrGreen-JekyllTheme" target="_blank" rel="noopener noreferrer">Mr. Green</a></p>
    </footer>
  </div>
</div>
<div class="scroll-to-top-container">
        <a id="scroll-to-top" href="#main-wrapper" role="button" aria-label="Back to top" class="hover-effect"><i class="fa fa-angle-up"></i></a>
      </div></div>

    <div class="searchbox-container">
  <form id="searchbox-form" autocomplete="off">
    <input type="search" id="search-box" placeholder="Search"
    onkeyup="if(this.value!==''){document.getElementById('search-results').style.display = 'block';}"
    onfocusout="this.value='';"
    onblur="setTimeout(function(){ document.getElementById('search-results').style.display = 'none'; }, 100);">
    <ul id="search-results" ></ul>
  </form>
</div>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="/assets/js/main.js"></script>





<script src="/assets/js/simple-jekyll-search-1.9.2.min.js"></script><script>
  function loadSearch(jsonData, searchParam) {
    if (!jsonData) jsonData = '';
    var searchInput = document.getElementById('search-box');

    const simpleJekyllSearch = SimpleJekyllSearch({
      searchInput: searchInput
      ,resultsContainer: document.getElementById('search-results')
      ,json: jsonData
      ,searchResultTemplate: '<li> <a href="{url}"> <div> <div class="title">{title}</div> <div class="date">{date}</div> <div style="clear: both;"></div> </div> </a></li>'
      ,noResultsText: '<li>No results were found.</li>'
      ,limit: 10
      ,fuzzy: false
      ,formSubmit: document.getElementById('searchbox-form')
    });

    if (searchParam) {
      searchInput.value = searchParam;
      searchInput.focus();
      searchInput.disabled=false;
      setTimeout(function(){
        simpleJekyllSearch.search(searchParam);
      }, 400);
    }
  }

  </script>

<script>
    function isEmpty(value) {
      if (value === "" || value === null || typeof value === "undefined") return true;
      return false;
    }

    function getQueryParam (param, mach = true) {
      var queryString = window.location.search.substring(1);
      if (isEmpty(queryString)) return null;
      var queries = queryString.split("&");
      for (var i in queries) {
        var pair = decodeURIComponent(queries[i]).split("=");
        if (mach == true){
          if (pair[0] == param) {
            if (isEmpty(pair[1]) === false) return pair[1];
          }
        }else{
          return pair;
        }
        break;
      }
      return null;
    }

    const searchParam = getQueryParam('search');

    (async () => {
      let resp = await fetch('');
      if (!resp.ok) return;
      let jsonData = await resp.json();
      loadSearch(jsonData, searchParam);
    })();
  </script>



<script>
  CookieConsent.consentSettingHtml = "<div class=\"consent-settings\"> <h5>Cookie settings</h5> <br> <p class=\"info-text\">This website uses cookies to optimize site functionality. It will be activated with your approval. Please click each item below for cookie policy. </p> <table> <tr> <td onclick=\"$('.info[data-consent-info=necessary]').slideToggle();$(this).children('i').toggleClass('fa-plus-square-o').toggleClass('fa-minus-square-o')\"> <i class=\"fa-fw fa fa-plus-square-o\" aria-hidden=\"true\"></i> <p>Strictly necessary cookies</p> </td> <td> <span class=\"active_text\">Always active</span></td> </tr> </table> <div class=\"info\" data-consent-info=\"necessary\"> <p>These cookies are essential for the website function and cannot be disable. They are usually set when site function like color scheme etc. is changed. These cookies do not store any personally identifiable information. Enables storage related to security such as authentication functionality, fraud prevention, and other user protection. </p> </div> <table> <tr> <td onclick=\"$('.info[data-consent-info=analytics]').slideToggle();$(this).children('i').toggleClass('fa-plus-square-o').toggleClass('fa-minus-square-o')\"> <i class=\"fa-fw fa fa-plus-square-o\" aria-hidden=\"true\"></i> <p>Performance cookies</p> </td> <td> <label class=\"slide-switch\"> <input type=\"checkbox\" class=\"checkbox_switch\" checked=\"checked\" data-consent=\"analytics\"> <span class=\"slider\"></span> </label></td> </tr> </table> <div class=\"info\" data-consent-info=\"analytics\"> <p>Enables storage (such as cookies) related to analytics e.g. visit duration. </p> </div> <table> <tr> <td onclick=\"$('.info[data-consent-info=preferences]').slideToggle();$(this).children('i').toggleClass('fa-plus-square-o').toggleClass('fa-minus-square-o')\"> <i class=\"fa-fw fa fa-plus-square-o\" aria-hidden=\"true\"></i> <p>Functionality cookies</p> </td> <td> <label class=\"slide-switch\"> <input type=\"checkbox\" class=\"checkbox_switch\" data-consent=\"preferences\"> <span class=\"slider\"></span> </label></td> </tr> </table> <div class=\"info\" data-consent-info=\"preferences\"> <p>Enables storage that supports the functionality of the website or app e.g. language settings. Enables storage related to personalization e.g. video recommendations. </p> </div> <table> <tr> <td onclick=\"$('.info[data-consent-info=advertising]').slideToggle();$(this).children('i').toggleClass('fa-plus-square-o').toggleClass('fa-minus-square-o')\"> <i class=\"fa-fw fa fa-plus-square-o\" aria-hidden=\"true\"></i> <p>Targeting and advertising cookies</p> </td> <td> <label class=\"slide-switch\"> <input type=\"checkbox\" class=\"checkbox_switch\" data-consent=\"advertising\"> <span class=\"slider\"></span> </label></td> </tr> </table> <div class=\"info\" data-consent-info=\"advertising\"> <p>Enables storage (such as cookies) related to advertising. </p> </div> <br> <div class=\"button-holder\"> <a href=\"javascript:void(0);\" class=\"btn-base btn-left\" onclick=\"CookieConsent.consentSettingDone('deny');\" role=\"button\" rel=\"nofollow\">Deny</a> <a href=\"javascript:void(0);\" class=\"btn-base btn-priority\" onclick=\"CookieConsent.consentSettingDone('accept');\" role=\"button\" rel=\"nofollow\">Allow all</a> <a href=\"javascript:void(0);\" class=\"btn-base \" onclick=\"CookieConsent.consentSettingDone('save');\" role=\"button\" rel=\"nofollow\">Allow selection</a> </div> </div>";
  CookieConsent.consentSettingSlideType = 'slideBoxTopToDown';
  CookieConsent.consentBarHtml = "<div class=\"consent-bar\"> <a class=\"close-button\" href=\"javascript:void(0);\" onclick=\"CookieConsent.hideConsentBar();\" aria-label=\"Close\" role=\"button\" rel=\"nofollow\"><i class=\"fa-fw fa fa-times\"></i></a> <p>This website uses cookies to optimize site functionality. It will be activated with your approval. </p> <a href=\"javascript:void(0);\" class=\"btn-base \" onclick=\"CookieConsent.consentBarDone('deny');\" role=\"button\" rel=\"nofollow\">Deny</a> <a href=\"javascript:void(0);\" class=\"btn-base \" onclick=\"CookieConsent.consentBarDone('settings');\" role=\"button\" rel=\"nofollow\">Customize</a> <a href=\"javascript:void(0);\" class=\"btn-base btn-priority\" onclick=\"CookieConsent.consentBarDone('accept');\" role=\"button\" rel=\"nofollow\">Allow all</a> </div>";
  CookieConsent.consent_items = JSON.parse('{"necessary":{"group":["security_storage"],"value":"granted","wait_for_update":500,"cookie_domain":"","no_check_box":true},"analytics":{"group":["analytics_storage"],"value":"denied"},"preferences":{"group":["functionality_storage","personalization_storage"],"value":"denied"},"advertising":{"group":["ad_storage"],"value":"denied"}}');
  CookieConsent.hideConsentBarWithSaveButton = true;

  const consent_settings = CookieConsent.getConsentSettings();
  const default_configs = JSON.parse('{"anonymize_ip":true,"ads_data_redaction":true,"cookie_flags":"SameSite=None;Secure"}');
</script>
<script>
  LangOfferMsgBox.currentPageLng = "en";
  LangOfferMsgBox.supportedLngList = [["en","En","/","View this page in English.","To home","Language"],["ja","Jp","/ja","„Åì„ÅÆ„Éö„Éº„Ç∏„ÇíÊó•Êú¨Ë™û„ÅßË°®Á§∫„Åô„Çã„ÄÇ","Êó•Êú¨Ë™û„Éõ„Éº„É†„Å∏","Ë®ÄË™û"],["pt","Pt","/pt","Veja esta p√°gina em portugu√™s.","P√°gina principal","Idioma"],["fr","Fr","/fr","Voir cette page en fran√ßais.","Aller √† l'accueil fran√ßais","Langue"],["zh","Cn","/zh","ÊòæÁ§∫ÁÆÄ‰Ωì‰∏≠ÊñáÈ°µÈù¢","ÁÆÄ‰Ωì‰∏≠ÊñáÈ°µÈù¢","ËØ≠Ë®Ä"],["ko","Ko","/ko","Ïù¥ ÌéòÏù¥ÏßÄÎ•º ÌïúÍµ≠Ïñ¥Î°ú Î≥¥ÏÑ∏Ïöî.","ÌïúÍµ≠Ïñ¥ ÌôàÌéòÏù¥ÏßÄÎ°ú","Ïñ∏Ïñ¥"],["tr","Tr","/tr","Bu sayfayƒ± T√ºrk√ße de g√∂r√ºnt√ºleyin.","T√ºrk√ße Ana sayfaya","Dil"],["es","Es","/es","Ver esta p√°gina en espa√±ol.","Ir a inicio","Idioma"]];
  LangOfferMsgBox.existLng = [];
  LangOfferMsgBox.disableExtTranslationOffer = true;
  LangOfferMsgBox.slideType = 'slideBoxTopToDown';
</script>
<script>
  SlidingMsgBox.html = "<div class=\"slideBox\"> <a class=\"close-button\" href=\"javascript:void(0);\" aria-label=\"Close\" role=\"button\" rel=\"nofollow\"><i class=\"fa-fw fa fa-times\"></i></a> </div>";
</script>
</body>
</html>

